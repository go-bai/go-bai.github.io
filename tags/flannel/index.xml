<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Flannel on gobai's blog</title><link>/tags/flannel/</link><description>Recent content in Flannel on gobai's blog</description><generator>Hugo</generator><language>en-us</language><lastBuildDate>Wed, 01 Jan 2025 13:11:35 +0800</lastBuildDate><atom:link href="/tags/flannel/index.xml" rel="self" type="application/rss+xml"/><item><title>深入了解 Kubernetes CNI 网络插件 Flannel</title><link>/posts/flannel/</link><pubDate>Wed, 01 Jan 2025 13:11:35 +0800</pubDate><guid>/posts/flannel/</guid><description>&lt;h2 id="关于">关于&lt;/h2>
&lt;p>&lt;a href="https://github.com/flannel-io/flannel">flannel&lt;/a> 是由 CoreOS 开发的一个简单易用的容器网络插件&lt;/p>
&lt;p>网络是 k8s 中至关重要的一部分, 这里以简单的 flannel 为例做深入分析&lt;/p>
&lt;h3 id="工作原理">工作原理&lt;/h3>
&lt;blockquote>
&lt;p>以下介绍在 chart 方式部署的 flannel&lt;/p>
&lt;/blockquote>
&lt;p>flanneld 进程以 daemonset/kube-flannel-ds 方式运行在所有 node 上, 负责从提前配置好的网络池中分配子网租约 (subnet lease) 给 node.&lt;/p>
&lt;p>flanneld 使用 k8s api 或者 etcd 存储网络配置、分配的子网和任何补充数据(如 node 的 public ip), 在 k8s 中使用一般不会单独提供 etcd 去存储这些数据.&lt;/p>
&lt;ul>
&lt;li>网络配置存储在 configmap 中, kube-flannel ns 下的 cm/kube-flannel-cfg 中&lt;/li>
&lt;li>分配的子网存储在 PodCIDR 中&lt;/li>
&lt;/ul>
&lt;p>几个名词解释:&lt;/p>
&lt;ol>
&lt;li>&lt;code>subnet&lt;/code>: 对应 &lt;code>node.spec.podCIDR&lt;/code>。&lt;/li>
&lt;li>&lt;code>backend&lt;/code>: 负责 &lt;code>node&lt;/code> 之间 &lt;code>pod&lt;/code> 通讯的后端。&lt;/li>
&lt;/ol>
&lt;p>flanneld 进程通过监听 &lt;code>node&lt;/code> 资源来生成 &lt;code>subnet event&lt;/code>, 然后在对应 &lt;code>backend&lt;/code> 的 &lt;code>handleSubnetEvents&lt;/code> 方法中处理逻辑，对于 &lt;code>vxlan backend&lt;/code> 主要是按顺序设置 &lt;code>arp&lt;/code>, &lt;code>fdb&lt;/code> 和 &lt;code>route&lt;/code> 来实现pod跨节点通讯。&lt;/p></description></item></channel></rss>