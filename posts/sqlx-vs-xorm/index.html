<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>sqlx vs xorm | gobai's blog</title>
<link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/xcode.min.css rel=stylesheet><style>h2::before,h3::before,h4::before,h5::before{color:#8f8f8f}h2::before{content:"## "}h3::before{content:"### "}h4::before{content:"#### "}h5::before{content:"##### "}</style></head><body><nav><ul class=menu><li><a href=/>Home</a></li><li><a href=/about/>About</a></li><li><a href=/tags/>Tags</a></li><li><a href=/index.xml>Subscribe</a></li></ul><hr></nav><div class=article-meta><h1><span class=title>sqlx vs xorm</span></h1><h4 class=date>2024/03/09</h4><p class=terms>Tags: <a href=/tags/golang>golang</a> <a href=/tags/sqlx>sqlx</a> <a href=/tags/golang>golang</a> <a href=/tags/database>database</a> <a href=/tags/sql>sql</a></p></div><nav id=TableOfContents><ul><li><a href=#初始化演示环境>初始化演示环境</a><ul><li><a href=#使用docker部署>使用docker部署</a></li><li><a href=#使用psql连接>使用<code>psql</code>连接</a></li><li><a href=#初始化uservps和host表>初始化<code>user</code>,<code>vps</code>和<code>host</code>表</a></li><li><a href=#查看创建出的表>查看创建出的表</a></li><li><a href=#初始化数据>初始化数据</a></li></ul></li><li><a href=#关于-databasesql>关于 <code>database/sql</code></a></li><li><a href=#关于-sqlx>关于 <code>sqlx</code></a></li><li><a href=#关于-xorm>关于 <code>xorm</code></a></li><li><a href=#使用场景对比>使用场景对比</a><ul><li><a href=#前情提要>前情提要</a></li><li><a href=#场景一-upsertinsterupdate>场景一: upsert/inster/update</a></li><li><a href=#场景二-getselect>场景二: get/select</a><ul><li><a href=#分页查询并获取总行数selectandcount>分页查询并获取总行数<code>SelectAndCount</code></a></li></ul></li><li><a href=#场景三-获取插入行的id>场景三: 获取插入行的id</a></li><li><a href=#场景四-连表查询>场景四: 连表查询</a></li><li><a href=#场景五-sql日志和trace>场景五: sql日志和trace</a></li><li><a href=#场景六>场景六:</a></li><li><a href=#一些注意点>一些注意点</a><ul><li><a href=#heading></a></li></ul></li></ul></li><li><a href=#对比总结>对比总结</a></li></ul></nav><main><h2 id=初始化演示环境>初始化演示环境</h2><h3 id=使用docker部署>使用docker部署</h3><p>部署的当前时间最新版本<code>postgres:16.2</code></p><pre><code class=language-bash>docker run -d --name pgsql \
  -e POSTGRES_USER=admin \
  -e POSTGRES_PASSWORD=admin \
  -e POSTGRES_DB=testdb \
  -p 15432:5432 \
  postgres:16.2
</code></pre><h3 id=使用psql连接>使用<code>psql</code>连接</h3><pre><code class=language-bash>docker exec -it pgsql psql -U admin -d testdb
</code></pre><h3 id=初始化uservps和host表>初始化<code>user</code>,<code>vps</code>和<code>host</code>表</h3><pre><code class=language-sql>CREATE TABLE &quot;user&quot; (
    id bigserial PRIMARY KEY,
    username VARCHAR(255) NOT NULL,
    password VARCHAR(255) NOT NULL
);
CREATE TABLE &quot;host&quot; (
    id bigserial PRIMARY KEY,
    hostname VARCHAR(255) NOT NULL
);
CREATE TABLE &quot;vps&quot; (
    id bigserial PRIMARY KEY,
    user_id bigint NOT NULL,
    host_id bigint NOT NULL,
    name VARCHAR(255) NOT NULL,
    sys_disk jsonb NOT NULL DEFAULT '{}'
);
</code></pre><h3 id=查看创建出的表>查看创建出的表</h3><pre><code class=language-bash>testdb=# \z
                                 Access privileges
 Schema |    Name     |   Type   | Access privileges | Column privileges | Policies
--------+-------------+----------+-------------------+-------------------+----------
 public | host        | table    |                   |                   |
 public | host_id_seq | sequence |                   |                   |
 public | user        | table    |                   |                   |
 public | user_id_seq | sequence |                   |                   |
 public | vps         | table    |                   |                   |
 public | vps_id_seq  | sequence |                   |                   |
(6 rows)

testdb=# \d user
                                     Table &quot;public.user&quot;
  Column  |          Type          | Collation | Nullable |             Default
----------+------------------------+-----------+----------+----------------------------------
 id       | bigint                 |           | not null | nextval('user_id_seq'::regclass)
 username | character varying(255) |           | not null |
 password | character varying(255) |           | not null |
Indexes:
    &quot;user_pkey&quot; PRIMARY KEY, btree (id)

testdb=# \d host
                                     Table &quot;public.host&quot;
  Column  |          Type          | Collation | Nullable |             Default
----------+------------------------+-----------+----------+----------------------------------
 id       | bigint                 |           | not null | nextval('host_id_seq'::regclass)
 hostname | character varying(255) |           | not null |
Indexes:
    &quot;host_pkey&quot; PRIMARY KEY, btree (id)

testdb=# \d vps
                                     Table &quot;public.vps&quot;
  Column  |          Type          | Collation | Nullable |             Default
----------+------------------------+-----------+----------+---------------------------------
 id       | bigint                 |           | not null | nextval('vps_id_seq'::regclass)
 user_id  | bigint                 |           | not null |
 host_id  | bigint                 |           | not null |
 name     | character varying(255) |           | not null |
 sys_disk | jsonb                  |           | not null | '{}'::jsonb
Indexes:
    &quot;vps_pkey&quot; PRIMARY KEY, btree (id)
</code></pre><h3 id=初始化数据>初始化数据</h3><pre><code class=language-sql>-- 插入用户数据
INSERT INTO &quot;user&quot; (username, password) VALUES
    ('user1', 'password1'),
    ('user2', 'password2');

-- 插入主机数据
INSERT INTO &quot;host&quot; (hostname) VALUES
    ('host1'),
    ('host2');

-- user1 在 host1 上创建一个 VPS
INSERT INTO &quot;vps&quot; (user_id, host_id, name, sys_disk) VALUES
    ((SELECT id FROM &quot;user&quot; WHERE username = 'user1'), (SELECT id FROM host WHERE hostname = 'host1'), 'vps_user1_host1', '{&quot;disk_size&quot;: 50}');

-- user2 在 host1 上创建一个 VPS
INSERT INTO &quot;vps&quot; (user_id, host_id, name, sys_disk) VALUES
    ((SELECT id FROM &quot;user&quot; WHERE username = 'user2'), (SELECT id FROM host WHERE hostname = 'host1'), 'vps_user2_host1', '{&quot;disk_size&quot;: 60}');

-- user1 在 host2 上创建一个 VPS
INSERT INTO &quot;vps&quot; (user_id, host_id, name, sys_disk) VALUES
    ((SELECT id FROM &quot;user&quot; WHERE username = 'user1'), (SELECT id FROM host WHERE hostname = 'host2'), 'vps_user1_host2', '{&quot;disk_size&quot;: 70}');

-- user2 在 host2 上创建一个 VPS
INSERT INTO &quot;vps&quot; (user_id, host_id, name, sys_disk) VALUES
    ((SELECT id FROM &quot;user&quot; WHERE username = 'user2'), (SELECT id FROM host WHERE hostname = 'host2'), 'vps_user2_host2', '{&quot;disk_size&quot;: 80}');
</code></pre><h2 id=关于-databasesql>关于 <code>database/sql</code></h2><p><code>database/sql</code>提供了操作SQL数据库的通用接口, 需要结合<code>database driver</code>同时使用, 这里是一些<a href=https://go.dev/wiki/SQLDrivers>驱动列表</a></p><p>使用用例可以看<a href=https://go.dev/wiki/SQLInterface>官方wiki</a></p><h2 id=关于-sqlx>关于 <code>sqlx</code></h2><h2 id=关于-xorm>关于 <code>xorm</code></h2><h2 id=使用场景对比>使用场景对比</h2><h3 id=前情提要>前情提要</h3><p>使用</p><h3 id=场景一-upsertinsterupdate>场景一: upsert/inster/update</h3><p>插入结构体时, <code>nil</code>值类型字段会被怎么处理?</p><p>如何指定只插入某些字段</p><h3 id=场景二-getselect>场景二: get/select</h3><h4 id=分页查询并获取总行数selectandcount>分页查询并获取总行数<code>SelectAndCount</code></h4><h3 id=场景三-获取插入行的id>场景三: 获取插入行的id</h3><h3 id=场景四-连表查询>场景四: 连表查询</h3><h3 id=场景五-sql日志和trace>场景五: sql日志和trace</h3><h3 id=场景六>场景六:</h3><h3 id=一些注意点>一些注意点</h3><ol><li>xorm</li></ol><h4 id=heading></h4><h2 id=对比总结>对比总结</h2><p>经过使用<code>sqlx</code>来应对日常开发对我来说也是比较顺手的, 可以意识到一些使用<code>xorm</code>注意不到的点, 比如</p></main><footer><script defer src=https://cdn.jsdelivr.net/npm/@xiee/utils/js/center-img.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script>hljs.configure({languages:[]}),hljs.highlightAll()</script><hr>© <a href=https://blog.gocn.top>gobai</a> 2021 &ndash; 2024 | <a href=https://github.com/go-bai>Github</a></footer></body></html>