<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Node Exporter | gobai's blog</title>
<link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/xcode.min.css rel=stylesheet><style>h2::before,h3::before,h4::before,h5::before{color:#8f8f8f}h2::before{content:"## "}h3::before{content:"### "}h4::before{content:"#### "}h5::before{content:"##### "}</style></head><body><nav><ul class=menu><li><a href=/>博客</a></li><li><a href=/about/>关于我</a></li><li><a href=/links/>友链</a></li><li><a href=/tags/>标签</a></li><li><a href=/index.xml>订阅</a></li></ul><hr></nav><div class=article-meta><h1><span class=title>Node Exporter</span></h1><p class=date>2024/07/03</p><p class=terms>Tags: <a href=/tags/prometheus>prometheus</a> <a href=/tags/node-exporter>node-exporter</a></p></div><nav id=TableOfContents><ul><li><a href=#node-exporter-安装>node-exporter 安装</a><ul><li><a href=#生成账号密码的-bcrypt-hash>生成账号密码的 bcrypt hash</a><ul><li><a href=#关于-bcrypt>关于 bcrypt</a></li></ul></li><li><a href=#运行-node-exporter>运行 node-exporter</a></li></ul></li><li><a href=#在-prometheus-中配置指标收集>在 prometheus 中配置指标收集</a><ul><li><a href=#方式一直接修改-prometheus-配置>方式一：直接修改 prometheus 配置</a></li><li><a href=#方式二配置-servicemonitor-进行自动服务发现>方式二：配置 <code>ServiceMonitor</code> 进行自动服务发现</a></li></ul></li></ul></nav><main><h2 id=node-exporter-安装>node-exporter 安装</h2><h3 id=生成账号密码的-bcrypt-hash>生成账号密码的 bcrypt hash</h3><pre><code class=language-bash>apt install apache2-utils -y
</code></pre><p>生成一个账号密码的 bcrypt hash</p><ul><li><code>-B</code> 强制使用 bcrypt 算法</li><li><code>-C 10</code> 指定 bcrypt 的 cost 值为 10, golang bcrypt 默认 cost 值也为 10</li></ul><p>注意修改下面的 <code>username</code> 和 <code>password</code> 为你要设置的账号密码</p><pre><code class=language-bash># htpasswd -nbBC 10 username password
username:$2y$10$poDYDLemE3r95gcQ.h8FdODudFaFZhwZCSX1RTwpI2s8V4Mwm0.lO
</code></pre><h4 id=关于-bcrypt>关于 bcrypt</h4><p>格式为 <code>$2&lt;a/b/x/y>$[cost]$[22 character salt][31 character hash]</code></p><p>例如</p><pre><code class=language-bash>$2y$10$poDYDLemE3r95gcQ.h8FdODudFaFZhwZCSX1RTwpI2s8V4Mwm0.lO
\__/\/ \____________________/\_____________________________/
Alg Cost      Salt                        Hash
</code></pre><h3 id=运行-node-exporter>运行 node-exporter</h3><ol><li>创建 <code>prometheus</code> 配置文件 <code>/etc/prometheus/web.yml</code></li><li>创建 <code>docker-compose.yml</code> 文件</li><li>运行 docker compose</li></ol><pre><code class=language-bash>PASS='$2y$10$poDYDLemE3r95gcQ.h8FdODudFaFZhwZCSX1RTwpI2s8V4Mwm0.lO'
mkdir -p /etc/prometheus

cat &lt;&lt;EOF&gt; /etc/prometheus/web.yml
basic_auth_users:
  # username: password
  prometheus: ${PASS}
EOF

cat &lt;&lt;EOF&gt; /etc/prometheus/docker-compose.yml
services:
  node-exporter:
    image: quay.io/prometheus/node-exporter:latest
    container_name: node-exporter
    command: 
      - &quot;--path.rootfs=/host&quot;
      - &quot;--web.config.file=/etc/prometheus/web.yml&quot;
    network_mode: &quot;host&quot;
    pid: host
    restart: always
    volumes:
      - '/:/host:ro,rslave'
      - /etc/prometheus/web.yml:/etc/prometheus/web.yml
EOF

docker compose -f /etc/prometheus/docker-compose.yml up -d
</code></pre><h2 id=在-prometheus-中配置指标收集>在 prometheus 中配置指标收集</h2><h3 id=方式一直接修改-prometheus-配置>方式一：直接修改 prometheus 配置</h3><p>修改 <code>kube-prometheus-stack</code> chart 配置并更新，或者直接修改保存配置的 configmap 中的 job 配置, 记得修改 <code>{EDIT_HERE}</code> 为实际值</p><pre><code class=language-bash>cat &lt;&lt;EOF&gt; custom_values.yaml
# prometheus service
prometheus:
  prometheusSpec:
    additionalScrapeConfigs:
      - job_name: 'node-exporter-external'
        basic_auth:
          username: {EDIT_HERE} # 这里是明文账号密码
          password: {EDIT_HERE}
        static_configs:
          - targets:
            - '{EDIT_HERE}:9100'
  service:
    type: NodePort

# grafana service
grafana:
  service:
    type: NodePort
EOF

helm upgrade  --install --create-namespace --namespace monitoring kube-prometheus-stack -f custom-values.yaml prometheus-community/kube-prometheus-stack
</code></pre><h3 id=方式二配置-servicemonitor-进行自动服务发现>方式二：配置 <code>ServiceMonitor</code> 进行自动服务发现</h3><p>把拉取 metrics 时需要的认证信息保存在 secret 中，然后创建 smon(ServiceMonitor)</p><pre><code class=language-yaml>apiVersion: v1
kind: Secret
metadata:
  name: node-exporter-external
  namespace: monitoring
data:
  username: {EDIT_HERE} # 这里是 base64 后的账号密码
  password: {EDIT_HERE}
type: Opaque
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: node-exporter-external
  namespace: monitoring
spec:
  namespaceSelector:
    matchNames:
    - monitoring
  selector:
    matchLabels:
      app: node-exporter-external
  jobLabel: app
  endpoints:
  - port: metrics
    path: /metrics
    interval: 5s
    basicAuth:
      username:
        name: node-exporter-external
        key: username
      password:
        name: node-exporter-external
        key: password
</code></pre><p>然后创建指向 node-expoter 服务的 endpoint 和同名 service</p><pre><code class=language-yaml>apiVersion: v1
kind: Endpoints
metadata:
  labels:
    app: node-exporter-external # 用来被 smon select
  name: node-exporter-external
  namespace: monitoring
subsets: # 所有 node exporter 地址信息
- addresses:
  - ip: 192.168.1.100
    nodeName: home
  ports:
  - name: metrics
    port: 9100
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: node-exporter-external # 用来设置 job 名称
  name: node-exporter-external
  namespace: monitoring
spec:
  ports:
  - name: metrics
    port: 9100
    targetPort: metrics
</code></pre></main><footer><script defer src=https://cdn.jsdelivr.net/npm/@xiee/utils/js/center-img.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script>hljs.configure({languages:[]}),hljs.highlightAll()</script><hr>© <a href=https://blog.gocn.top>gobai</a> 2021 &ndash; 2025 | <a href=https://github.com/go-bai>Github</a></footer></body></html>