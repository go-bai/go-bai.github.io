<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="数据库专题"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="/posts/db/"><meta property="og:site_name" content="gobai's blog"><meta property="og:title" content="Database"><meta property="og:description" content="数据库专题"><meta property="og:locale" content="en_us"><meta property="og:type" content="website"><title>Database | gobai's blog</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=/posts/db/><link rel=stylesheet href=/book.min.434035e7885c7f5d12818bd9f111cf1a0925c6fb78382667381c3d5eda3fb4f1.css><script defer src=/fuse.min.js></script><script defer src=/en.search.min.2d7343f7ad832e081ecba88fc9b1e7b83132fd3f25ba51c9e24716866b2ba73c.js></script><link rel=alternate type=application/rss+xml href=/posts/db/index.xml title="gobai's blog"></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><img src=/favicon.ico alt=Logo class=book-icon><span>gobai's blog</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><input type=checkbox id=section-2817774238063d11f9fedc418e8bcf3f class=toggle>
<label for=section-2817774238063d11f9fedc418e8bcf3f class="flex justify-between"><a role=button>Golang</a></label><ul><li><a href=/posts/sqlx-vs-xorm/>sqlx vs xorm</a></li><li><a href=/posts/solve-timezone-issue-in-go-application-in-container/>解决Go应用在容器中的时区问题</a></li><li><a href=/posts/go-app-reduce-size/>减小go程序编译后的体积</a></li></ul></li><li><input type=checkbox id=section-f91fe725fab4dcbef0dd504359ff7b63 class=toggle>
<label for=section-f91fe725fab4dcbef0dd504359ff7b63 class="flex justify-between"><a role=button>Linux</a></label><ul><li><a href=/posts/node-exporter/>Node Exporter</a></li><li><a href=/posts/rclone/>Rclone 使用笔记</a></li><li><a href=/posts/multi-bootable-usb/>Multi-Bootable USB</a></li><li><a href=/posts/shell-script/>Shell Script</a></li><li><a href=/posts/delete-partition-and-expand-another/>删除分区并扩容另一个分区和根文件系统</a></li><li><a href=/posts/ubuntu-config/>Ubuntu Config</a></li><li><a href=/posts/systemd-journal/>About Systemd</a></li><li><input type=checkbox id=section-176ad016ae09a9f0440dca17617492cb class=toggle>
<label for=section-176ad016ae09a9f0440dca17617492cb class="flex justify-between"><a role=button>Network</a></label><ul><li><a href=/posts/linux-iptables/>Linux iptables</a></li><li><a href=/posts/wireless-to-wired-network/>无线转有线网络</a></li><li><a href=/posts/openwrt/>OpenWrt</a></li><li><a href=/posts/dhclient/>dhclient</a></li><li><a href=/posts/creating-a-bridged-network-with-netplan-on-ubuntu-22-04/>在 Ubuntu 22.04 使用 netplan 创建桥接网络</a></li></ul></li></ul></li><li><input type=checkbox id=section-db6ac5e9808e911c643d4dada0e07ebd class=toggle>
<label for=section-db6ac5e9808e911c643d4dada0e07ebd class="flex justify-between"><a role=button>Kubernetes</a></label><ul><li><a href=/posts/flannel/>深入了解 Kubernetes CNI 网络插件 Flannel</a></li><li><a href=/posts/cni/>CNI 工作原理</a></li><li><a href=/posts/csi/>CSI 工作原理</a></li><li><a href=/posts/builing-multi-platform-container-images-guide/>构建多平台容器镜像</a></li><li><a href=/posts/kube-prometheus-stack/>安装 Kube Prometheus Stack</a></li><li><a href=/posts/rook-ceph/>安装 Rook Ceph</a></li><li><a href=/posts/rke2/>RKE2 安装 k8s 集群</a></li><li><a href=/posts/controller-runtime/>Controller Runtime</a></li><li><a href=/posts/kubevirt-sidecar/>Kubevirt Hook Sidecar</a></li></ul></li><li><input type=checkbox id=section-45ed28834a9c7fe37d3e4d15606fec65 class=toggle checked>
<label for=section-45ed28834a9c7fe37d3e4d15606fec65 class="flex justify-between"><a href=/posts/db/ class=active>Database</a></label><ul><li><a href=/posts/sqlite3/>SQLite3</a></li></ul></li><li><input type=checkbox id=section-71066de79af329dead5f497549dd47db class=toggle>
<label for=section-71066de79af329dead5f497549dd47db class="flex justify-between"><a role=button>Virtualization</a></label><ul><li><a href=/posts/libvirt/>Libvirt 使用笔记</a></li><li><a href=/posts/create-vm-with-cloudinit/>创建虚拟机时使用 cloudinit 初始化</a></li></ul></li><li><input type=checkbox id=section-11b3445850a0f3882808ba1894e9cf94 class=toggle>
<label for=section-11b3445850a0f3882808ba1894e9cf94 class="flex justify-between"><a role=button>其他</a></label><ul><li><a href=/posts/vscode-extensions/>Vscode Extensions</a></li><li><a href=/posts/macos-config/>MacOS Config</a></li><li><a href=/posts/vim-tricks/>Vim Tricks</a></li><li><a href=/posts/git-tricks/>Git Tricks</a></li></ul></li><li class=book-section-flat><span>&lt;&lt; 链接 >></span><ul><li><a href=/posts/about/>关于我</a></li><li><a href=/posts/links/>友链</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>Database</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav><ul><li class=book-section-flat><strong>Categories</strong><ul></ul></li><li class=book-section-flat><strong>Tags</strong><ul></ul></li></ul></nav></aside></header><article class="markdown book-post"><h2><a href=/posts/sqlite3/>SQLite3</a></h2><div class="flex align-center text-small book-post-date"><img src=/svg/calendar.svg class=book-icon alt>
<span>2021-12-14</span></div><div class=book-post-content><h2 id=rollback日志模式下的五种锁状态介绍>rollback日志模式下的五种锁状态介绍
<a class=anchor href=#rollback%e6%97%a5%e5%bf%97%e6%a8%a1%e5%bc%8f%e4%b8%8b%e7%9a%84%e4%ba%94%e7%a7%8d%e9%94%81%e7%8a%b6%e6%80%81%e4%bb%8b%e7%bb%8d>#</a></h2><ul><li><code>UNLOCKED</code><ul><li>没锁状态</li></ul></li><li><code>SHARED</code><ul><li>获取<code>SHARED</code>锁才能执行读操作，一个数据库可同时存在多个<code>SHARED</code>锁</li></ul></li><li><code>RESERVED</code><ul><li>获取<code>RESERVED</code>锁才能在未来写数据库，一个数据库同一时间只能存在一个<code>RESERVED</code>锁</li><li>有<code>RESERVED</code>锁时说明还没开始写，所以有<code>RESERVED</code>锁时可以获取新的<code>SHARED</code>锁</li></ul></li><li><code>PENDING</code><ul><li>有<code>PENDING</code>锁意味着要开始写了，但是此时有其他连接拥有<code>SHARED</code>锁在读数据，此时写操作只能等待所有<code>SHARED</code>释放。</li><li><code>PENDING</code>阻塞其他连接获取新的<code>SHARED</code>锁，当<code>SHARED</code>锁释放完时转为<code>EXCLUSIVE</code>锁开始写操作。</li></ul></li><li><code>EXCLUSIVE</code><ul><li>同一时间只能存在一个<code>EXCLUSIVE</code>锁，并且有<code>EXCLUSIVE</code>锁存在时不允许其他任何锁类型存在。</li></ul></li></ul><p>所以总结一下就是读读可并发，读写不可并发，写写不可并发。</p><h2 id=优化篇>优化篇
<a class=anchor href=#%e4%bc%98%e5%8c%96%e7%af%87>#</a></h2><h3 id=sqlite_busy-问题><code>SQLITE_BUSY</code> 问题
<a class=anchor href=#sqlite_busy-%e9%97%ae%e9%a2%98>#</a></h3><p>看到上面这么多锁不能共存的情况应该会想到，冲突会很频繁，如 <code>EXCLUSIVE</code> 锁存在时不允许其他连接获取任何锁，当其他进程需要读写操作时就会获取锁失败，立即报 <code>SQLITE_BUSY</code> 错误。</p><p>设置 <code>busy_timeout</code> 就不会立即返回 <code>SQLITE_BUSY</code>，会定时retry失败的操作，如果在设置的 <code>busy_timeout</code> 时间内还没执行成功，依然会返回 <code>SQLITE_BUSY</code>。</p><p>使用不同sqlite驱动，设置 <code>busy_timeout</code> 的方式不同</p><ul><li>modernc.org/sqlite <code>database.db?_pragma=busy_timeout%3d50000</code></li><li>github.com/mattn/go-sqlite3 <code>database.db?_busy_timeout=50000</code></li></ul><p>Shared cache mode 支持 table level locks，暂时还没研究。</p><h3 id=针对写操作慢的问题>针对写操作慢的问题
<a class=anchor href=#%e9%92%88%e5%af%b9%e5%86%99%e6%93%8d%e4%bd%9c%e6%85%a2%e7%9a%84%e9%97%ae%e9%a2%98>#</a></h3><p>解决方案：将多个写操作放入一个事务里执行。sqlite官方<a href=https://www.sqlite.org/faq.html#q19>FAQ</a>对其解释如下</p><blockquote><p>(19) INSERT is really slow - I can only do few dozen INSERTs per second
Actually, SQLite will easily do 50,000 or more INSERT statements per second on an average desktop computer. But it will only do a few dozen transactions per second. Transaction speed is limited by the rotational speed of your disk drive. A transaction normally requires two complete rotations of the disk platter, which on a 7200RPM disk drive limits you to about 60 transactions per second.
Transaction speed is limited by disk drive speed because (by default) SQLite actually waits until the data really is safely stored on the disk surface before the transaction is complete. That way, if you suddenly lose power or if your OS crashes, your data is still safe. For details, read about <a href=https://www.sqlite.org/atomiccommit.html>atomic commit in SQLite..</a>
By default, each INSERT statement is its own transaction. But if you surround multiple INSERT statements with BEGIN&mldr;COMMIT then all the inserts are grouped into a single transaction. The time needed to commit the transaction is amortized over all the enclosed insert statements and so the time per insert statement is greatly reduced.
Another option is to run PRAGMA synchronous=OFF. This command will cause SQLite to not wait on data to reach the disk surface, which will make write operations appear to be much faster. But if you lose power in the middle of a transaction, your database file might go corrupt.</p><a href=/posts/sqlite3/>...</a></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/go-bai/go-bai.github.io/commit/390d99988c3f7e00d9db00857e1ae58d43a80b98 title='Last modified by go-bai | 2025-03-02' target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt>
<span>2025-03-02</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav><ul><li class=book-section-flat><strong>Categories</strong><ul></ul></li><li class=book-section-flat><strong>Tags</strong><ul></ul></li></ul></nav></div></aside></main></body></html>