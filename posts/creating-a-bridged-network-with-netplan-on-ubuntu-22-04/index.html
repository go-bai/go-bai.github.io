<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Creating a bridged network with netplan on Ubuntu 22.04 | gobai's blog</title>
<link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/xcode.min.css rel=stylesheet></head><body><nav><ul class=menu><li><a href=/>Home</a></li><li><a href=/about/>About</a></li><li><a href=/tags/>Tags</a></li><li><a href=/index.xml>Subscribe</a></li></ul><hr></nav><div class=article-meta><h1><span class=title>Creating a bridged network with netplan on Ubuntu 22.04</span></h1><h4 class=date>2023/10/04</h4><p class=terms>Tags: <a href=/tags/linux>linux</a> <a href=/tags/bridged-network>bridged-network</a> <a href=/tags/netplan>netplan</a> <a href=/tags/ubuntu>ubuntu</a></p></div><nav id=TableOfContents><ul><li><a href=#创建一个bridged-network>创建一个<code>bridged network</code></a></li><li><a href=#应用网络配置>应用网络配置</a></li><li><a href=#补充>补充</a></li></ul></nav><main><p>本地LAN环境</p><ol><li>LAN网关 <code>192.168.1.1</code></li><li>子网掩码 <code>255.255.255.0</code></li><li>DHCP范围 <code>192.168.1.2</code>-<code>192.168.32</code></li></ol><h2 id=创建一个bridged-network>创建一个<code>bridged network</code></h2><p>创建一个网桥<code>br0</code>给虚机使用，使得虚机和其他设备都在一个LAN下</p><p>总配置(<code>netplan get</code>)如下:</p><pre><code class=language-yaml>network:
  version: 2
  renderer: NetworkManager
  ethernets:
    enp1s0:
      dhcp4: false
      dhcp6: false
  bridges:
    br0:
      addresses:
      - &quot;192.168.1.100/24&quot;
      nameservers:
        addresses:
        - 192.168.1.1
      dhcp4: false
      dhcp6: false
      interfaces:
      - enp1s0
      parameters:
        stp: false
      routes:
      - to: &quot;default&quot;
        via: &quot;192.168.1.1&quot;
</code></pre><p>由三个文件组成:</p><ol><li><code>/etc/netplan/01-network-manager-all.yaml</code></li></ol><pre><code class=language-yaml># Let NetworkManager manage all devices on this system
network:
  version: 2
  renderer: NetworkManager
</code></pre><ol start=2><li><code>/etc/netplan/10-ethernet-enp1s0.yaml</code></li></ol><pre><code class=language-yaml>network:
  ethernets:
    enp1s0:
      dhcp4: false
      dhcp6: false
</code></pre><ol start=3><li><code>/etc/netplan/99-bridged-network-br0.yaml</code></li></ol><pre><code class=language-yaml>network:
  bridges:
    br0:
      dhcp4: false
      dhcp6: false
      addresses:
        - 192.168.1.100/24
      routes:
        - to: default
          via: 192.168.1.1
      nameservers:
        addresses: 
          - 192.168.1.1
          - 223.5.5.5
      interfaces:
        - enp1s0
      parameters:
        stp: false
</code></pre><h2 id=应用网络配置>应用网络配置</h2><p>容易失联，如果是ssh远程操作请谨慎操作</p><pre><code class=language-bash>netplan apply
</code></pre><h2 id=补充>补充</h2><ol><li>如何没有安装<code>NetworkManager</code>需要先安装(通过<code>systemctl status NetworkManager</code>查看是否安装)</li></ol><pre><code class=language-bash>apt install network-manager -y
</code></pre><ol start=2><li>生产环境可以<code>systemd-networkd</code>和<code>NetworkManager</code>共存, 但是在我这里遇到了一些问题</li></ol><p><a href=https://nmstate.io/>nmstate</a> 依赖<code>NetworkManager</code>服务, NM可以使用<code>10-globally-managed-devices.conf</code>配置不管理哪些接口</p><ol start=3><li>禁用 <code>systemd-networkd</code></li></ol><pre><code class=language-bash># 先关闭 systemd-networkd.socket, 否则每次关闭 systemd-networkd 都会被马上重新激活
systemctl stop systemd-networkd.socket
systemctl disable systemd-networkd.socket

systemctl stop systemd-networkd
systemctl disable systemd-networkd
</code></pre><ol start=4><li><code>netplan apply</code>之后会发现<code>br0</code>会出现好几个<code>inet6</code></li></ol><p>相关讨论 <a href=https://www.linuxquestions.org/questions/linux-networking-3/why-does-my-ubuntu-server-have-4-ipv6-addresses-4175701900/>Why does my ubuntu-server have 4 ipv6 addresses?</a></p></main><footer><script defer src=https://cdn.jsdelivr.net/npm/@xiee/utils/js/center-img.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script>hljs.configure({languages:[]}),hljs.highlightAll()</script><hr>© <a href=https://blog.gocn.top>gobai</a> 2021 &ndash; 2024 | <a href=https://github.com/go-bai>Github</a></footer></body></html>