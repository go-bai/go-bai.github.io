<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>深入了解 Kubernetes CNI 网络插件 Flannel | gobai's blog</title>
<link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/xcode.min.css rel=stylesheet><style>h2::before,h3::before,h4::before,h5::before{color:#8f8f8f}h2::before{content:"## "}h3::before{content:"### "}h4::before{content:"#### "}h5::before{content:"##### "}</style></head><body><nav><ul class=menu><li><a href=/>博客</a></li><li><a href=/about/>关于我</a></li><li><a href=/links/>友链</a></li><li><a href=/tags/>标签</a></li><li><a href=/index.xml>订阅</a></li></ul><hr></nav><div class=article-meta><h1><span class=title>深入了解 Kubernetes CNI 网络插件 Flannel</span></h1><p class=date>2025/01/01</p><p class=terms>Tags: <a href=/tags/flannel>flannel</a></p></div><nav id=TableOfContents><ul><li><a href=#关于>关于</a><ul><li><a href=#工作原理>工作原理</a><ul><li><a href=#推荐的-backend>推荐的 backend</a><ul><li><a href=#vxlan-virtual-extensible-lan-虚拟可扩展局域网>VXLAN (Virtual eXtensible LAN) 虚拟可扩展局域网</a></li><li><a href=#host-gw>host-gw</a></li><li><a href=#wireguard>WireGuard</a></li><li><a href=#udp>UDP</a></li></ul></li></ul></li><li><a href=#支持-network-policy-的安装方式>支持 Network Policy 的安装方式</a><ul><li><a href=#通过-chart-安装-flannel>通过 <code>chart</code> 安装 <code>flannel</code></a></li></ul></li></ul></li></ul></nav><main><h2 id=关于>关于</h2><p><a href=https://github.com/flannel-io/flannel>flannel</a> 是由 CoreOS 开发的一个简单易用的容器网络插件</p><p>网络是 k8s 中至关重要的一部分, 这里以简单的 flannel 为例做深入分析</p><h3 id=工作原理>工作原理</h3><blockquote><p>以下介绍在 chart 方式部署的 flannel</p></blockquote><p>flanneld 进程以 daemonset/kube-flannel-ds 方式运行在所有 node 上, 负责从提前配置好的网络池中分配子网租约 (subnet lease) 给 node.</p><p>flanneld 使用 k8s api 或者 etcd 存储网络配置、分配的子网和任何补充数据(如 node 的 public ip), 在 k8s 中使用一般不会单独提供 etcd 去存储这些数据.</p><ul><li>网络配置存储在 configmap 中, kube-flannel ns 下的 cm/kube-flannel-cfg 中</li><li>分配的子网存储在 PodCIDR 中</li></ul><p>flannel 通过 informer 去 list/watch node 资源来动态设置网络, 主要是设置 route, arp 和 fdb 网络配置.</p><p>flannel 支持多种 pod 之间数据的转发后端(<code>backend</code>), 一旦设置 <code>backend</code> 就不应该在运行中更改, 推荐使用 <code>VXLAN</code></p><h4 id=推荐的-backend>推荐的 backend</h4><h5 id=vxlan-virtual-extensible-lan-虚拟可扩展局域网>VXLAN (Virtual eXtensible LAN) 虚拟可扩展局域网</h5><p>关于 <a href=https://www.kernel.org/doc/Documentation/networking/vxlan.txt>VXLAN</a> 简单介绍:</p><p>VXLAN 协议是一个隧道协议, 用来解决 VLAN ID 在 IEEE 802.1q 中限制只能有 4096(12bit) 个的问题. 在 VXLAN 中, VXLAN 标识符(VNI)的大小扩展至 16777216(24bit).</p><p>VXLAN 由 <a href=https://datatracker.ietf.org/doc/html/rfc7348>IETF RFC7348</a> 描述, 并且被很多厂商实现(如linux kernel vxlan module)了, 该协议使用单个目的端口(一般是<code>4789</code>)运行在 UDP 之上.</p><h5 id=host-gw>host-gw</h5><p>使用host-gw创建通过远程机器IP到子网的IP路由, 需要在运行 flannel 的主机之间建立直接的 layer2 连接</p><p>Host-gw提供了良好的性能, 很少依赖, 并且易于设置</p><h5 id=wireguard>WireGuard</h5><p>使用内核内的WireGuard封装和加密报文.</p><h5 id=udp>UDP</h5><p>如果你的网络和内核不支持使用VXLAN或host-gw, 则仅在调试时使用UDP.</p><hr><h3 id=支持-network-policy-的安装方式>支持 Network Policy 的安装方式</h3><p>从 <code>v0.25.5</code> 开始, 可以和 flannel 在同一个 pod 中一起部署 <a href=https://github.com/kubernetes-sigs/kube-network-policies>kube-network-policies</a> 来提供 network policy controller.</p><h4 id=通过-chart-安装-flannel>通过 <code>chart</code> 安装 <code>flannel</code></h4><p>当前 chart 已经支持部署 kube-network-policies, 设置 <code>netpol.enabled=true</code> 即可</p><pre><code class=language-bash>mkdir -p ~/charts/flannel/flannel
cd ~/charts/flannel/flannel
helm repo add flannel https://flannel-io.github.io/flannel/
# values.yaml 用来查看默认值
helm show values flannel/flannel &gt; values.yaml
cat &lt;&lt;EOF &gt; custom-values.yaml
podCidr: &quot;10.42.0.0/16&quot;

flannel:
  image:
    repository: docker.io/flannel/flannel
    tag: v0.26.2
  image_cni:
    repository: docker.io/flannel/flannel-cni-plugin
    tag: v1.6.0-flannel1
  args:
  - &quot;--ip-masq&quot;
  - &quot;--kube-subnet-mgr&quot;
  backend: &quot;vxlan&quot;
  backendPort: 4789
  mtu: 1450
  vni: 4096

netpol:
  enabled: true
  args:
  - &quot;--hostname-override=\$(MY_NODE_NAME)&quot;
  - &quot;--v=2&quot;
  image:
    repository: registry.k8s.io/networking/kube-network-policies
    tag: v0.4.0
EOF
kubectl create ns kube-flannel
kubectl label --overwrite ns kube-flannel pod-security.kubernetes.io/enforce=privileged
helm upgrade --install --namespace kube-flannel flannel flannel/flannel -f custom-values.yaml
</code></pre><hr><p>TODO</p></main><footer><script defer src=https://cdn.jsdelivr.net/npm/@xiee/utils/js/center-img.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script>hljs.configure({languages:[]}),hljs.highlightAll()</script><hr>© <a href=https://blog.gocn.top>gobai</a> 2021 &ndash; 2025 | <a href=https://github.com/go-bai>Github</a></footer></body></html>