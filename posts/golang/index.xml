<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Golang on gobai's blog</title><link>/posts/golang/</link><description>Recent content in Golang on gobai's blog</description><generator>Hugo</generator><language>en-us</language><atom:link href="/posts/golang/index.xml" rel="self" type="application/rss+xml"/><item><title>sqlx vs xorm</title><link>/posts/sqlx-vs-xorm/</link><pubDate>Sat, 09 Mar 2024 10:49:09 +0800</pubDate><guid>/posts/sqlx-vs-xorm/</guid><description>&lt;h2 id="初始化演示环境">
 初始化演示环境
 &lt;a class="anchor" href="#%e5%88%9d%e5%a7%8b%e5%8c%96%e6%bc%94%e7%a4%ba%e7%8e%af%e5%a2%83">#&lt;/a>
&lt;/h2>
&lt;h3 id="使用docker部署">
 使用docker部署
 &lt;a class="anchor" href="#%e4%bd%bf%e7%94%a8docker%e9%83%a8%e7%bd%b2">#&lt;/a>
&lt;/h3>
&lt;p>部署的当前时间最新版本&lt;code>postgres:16.2&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>docker run -d --name pgsql &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> -e POSTGRES_USER&lt;span style="color:#f92672">=&lt;/span>admin &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> -e POSTGRES_PASSWORD&lt;span style="color:#f92672">=&lt;/span>admin &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> -e POSTGRES_DB&lt;span style="color:#f92672">=&lt;/span>testdb &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> -p 15432:5432 &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> postgres:16.2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="使用psql连接">
 使用&lt;code>psql&lt;/code>连接
 &lt;a class="anchor" href="#%e4%bd%bf%e7%94%a8psql%e8%bf%9e%e6%8e%a5">#&lt;/a>
&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>docker exec -it pgsql psql -U admin -d testdb
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="初始化uservps和host表">
 初始化&lt;code>user&lt;/code>,&lt;code>vps&lt;/code>和&lt;code>host&lt;/code>表
 &lt;a class="anchor" href="#%e5%88%9d%e5%a7%8b%e5%8c%96uservps%e5%92%8chost%e8%a1%a8">#&lt;/a>
&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sql" data-lang="sql">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">CREATE&lt;/span> &lt;span style="color:#66d9ef">TABLE&lt;/span> &lt;span style="color:#e6db74">&amp;#34;user&amp;#34;&lt;/span> (
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> id bigserial &lt;span style="color:#66d9ef">PRIMARY&lt;/span> &lt;span style="color:#66d9ef">KEY&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> username VARCHAR(&lt;span style="color:#ae81ff">255&lt;/span>) &lt;span style="color:#66d9ef">NOT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> password VARCHAR(&lt;span style="color:#ae81ff">255&lt;/span>) &lt;span style="color:#66d9ef">NOT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">CREATE&lt;/span> &lt;span style="color:#66d9ef">TABLE&lt;/span> &lt;span style="color:#e6db74">&amp;#34;host&amp;#34;&lt;/span> (
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> id bigserial &lt;span style="color:#66d9ef">PRIMARY&lt;/span> &lt;span style="color:#66d9ef">KEY&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> hostname VARCHAR(&lt;span style="color:#ae81ff">255&lt;/span>) &lt;span style="color:#66d9ef">NOT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">CREATE&lt;/span> &lt;span style="color:#66d9ef">TABLE&lt;/span> &lt;span style="color:#e6db74">&amp;#34;vps&amp;#34;&lt;/span> (
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> id bigserial &lt;span style="color:#66d9ef">PRIMARY&lt;/span> &lt;span style="color:#66d9ef">KEY&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> user_id bigint &lt;span style="color:#66d9ef">NOT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> host_id bigint &lt;span style="color:#66d9ef">NOT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> name VARCHAR(&lt;span style="color:#ae81ff">255&lt;/span>) &lt;span style="color:#66d9ef">NOT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sys_disk jsonb &lt;span style="color:#66d9ef">NOT&lt;/span> &lt;span style="color:#66d9ef">NULL&lt;/span> &lt;span style="color:#66d9ef">DEFAULT&lt;/span> &lt;span style="color:#e6db74">&amp;#39;{}&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="查看创建出的表">
 查看创建出的表
 &lt;a class="anchor" href="#%e6%9f%a5%e7%9c%8b%e5%88%9b%e5%bb%ba%e5%87%ba%e7%9a%84%e8%a1%a8">#&lt;/a>
&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>testdb&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#75715e"># \z&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Access privileges
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Schema | Name | Type | Access privileges | Column privileges | Policies
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>--------+-------------+----------+-------------------+-------------------+----------
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> public | host | table | | |
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> public | host_id_seq | sequence | | |
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> public | user | table | | |
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> public | user_id_seq | sequence | | |
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> public | vps | table | | |
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> public | vps_id_seq | sequence | | |
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#ae81ff">6&lt;/span> rows&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>testdb&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#75715e"># \d user&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Table &lt;span style="color:#e6db74">&amp;#34;public.user&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Column | Type | Collation | Nullable | Default
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>----------+------------------------+-----------+----------+----------------------------------
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> id | bigint | | not null | nextval&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#39;user_id_seq&amp;#39;&lt;/span>::regclass&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> username | character varying&lt;span style="color:#f92672">(&lt;/span>255&lt;span style="color:#f92672">)&lt;/span> | | not null |
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> password | character varying&lt;span style="color:#f92672">(&lt;/span>255&lt;span style="color:#f92672">)&lt;/span> | | not null |
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Indexes:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;user_pkey&amp;#34;&lt;/span> PRIMARY KEY, btree &lt;span style="color:#f92672">(&lt;/span>id&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>testdb&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#75715e"># \d host&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Table &lt;span style="color:#e6db74">&amp;#34;public.host&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Column | Type | Collation | Nullable | Default
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>----------+------------------------+-----------+----------+----------------------------------
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> id | bigint | | not null | nextval&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#39;host_id_seq&amp;#39;&lt;/span>::regclass&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> hostname | character varying&lt;span style="color:#f92672">(&lt;/span>255&lt;span style="color:#f92672">)&lt;/span> | | not null |
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Indexes:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;host_pkey&amp;#34;&lt;/span> PRIMARY KEY, btree &lt;span style="color:#f92672">(&lt;/span>id&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>testdb&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#75715e"># \d vps&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Table &lt;span style="color:#e6db74">&amp;#34;public.vps&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Column | Type | Collation | Nullable | Default
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>----------+------------------------+-----------+----------+---------------------------------
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> id | bigint | | not null | nextval&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#39;vps_id_seq&amp;#39;&lt;/span>::regclass&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> user_id | bigint | | not null |
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> host_id | bigint | | not null |
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> name | character varying&lt;span style="color:#f92672">(&lt;/span>255&lt;span style="color:#f92672">)&lt;/span> | | not null |
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sys_disk | jsonb | | not null | &lt;span style="color:#e6db74">&amp;#39;{}&amp;#39;&lt;/span>::jsonb
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Indexes:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;vps_pkey&amp;#34;&lt;/span> PRIMARY KEY, btree &lt;span style="color:#f92672">(&lt;/span>id&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="初始化数据">
 初始化数据
 &lt;a class="anchor" href="#%e5%88%9d%e5%a7%8b%e5%8c%96%e6%95%b0%e6%8d%ae">#&lt;/a>
&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sql" data-lang="sql">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">-- 插入用户数据
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">INSERT&lt;/span> &lt;span style="color:#66d9ef">INTO&lt;/span> &lt;span style="color:#e6db74">&amp;#34;user&amp;#34;&lt;/span> (username, password) &lt;span style="color:#66d9ef">VALUES&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> (&lt;span style="color:#e6db74">&amp;#39;user1&amp;#39;&lt;/span>, &lt;span style="color:#e6db74">&amp;#39;password1&amp;#39;&lt;/span>),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> (&lt;span style="color:#e6db74">&amp;#39;user2&amp;#39;&lt;/span>, &lt;span style="color:#e6db74">&amp;#39;password2&amp;#39;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">-- 插入主机数据
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">INSERT&lt;/span> &lt;span style="color:#66d9ef">INTO&lt;/span> &lt;span style="color:#e6db74">&amp;#34;host&amp;#34;&lt;/span> (hostname) &lt;span style="color:#66d9ef">VALUES&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> (&lt;span style="color:#e6db74">&amp;#39;host1&amp;#39;&lt;/span>),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> (&lt;span style="color:#e6db74">&amp;#39;host2&amp;#39;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">-- user1 在 host1 上创建一个 VPS
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">INSERT&lt;/span> &lt;span style="color:#66d9ef">INTO&lt;/span> &lt;span style="color:#e6db74">&amp;#34;vps&amp;#34;&lt;/span> (user_id, host_id, name, sys_disk) &lt;span style="color:#66d9ef">VALUES&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ((&lt;span style="color:#66d9ef">SELECT&lt;/span> id &lt;span style="color:#66d9ef">FROM&lt;/span> &lt;span style="color:#e6db74">&amp;#34;user&amp;#34;&lt;/span> &lt;span style="color:#66d9ef">WHERE&lt;/span> username &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39;user1&amp;#39;&lt;/span>), (&lt;span style="color:#66d9ef">SELECT&lt;/span> id &lt;span style="color:#66d9ef">FROM&lt;/span> &lt;span style="color:#66d9ef">host&lt;/span> &lt;span style="color:#66d9ef">WHERE&lt;/span> hostname &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39;host1&amp;#39;&lt;/span>), &lt;span style="color:#e6db74">&amp;#39;vps_user1_host1&amp;#39;&lt;/span>, &lt;span style="color:#e6db74">&amp;#39;{&amp;#34;disk_size&amp;#34;: 50}&amp;#39;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">-- user2 在 host1 上创建一个 VPS
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">INSERT&lt;/span> &lt;span style="color:#66d9ef">INTO&lt;/span> &lt;span style="color:#e6db74">&amp;#34;vps&amp;#34;&lt;/span> (user_id, host_id, name, sys_disk) &lt;span style="color:#66d9ef">VALUES&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ((&lt;span style="color:#66d9ef">SELECT&lt;/span> id &lt;span style="color:#66d9ef">FROM&lt;/span> &lt;span style="color:#e6db74">&amp;#34;user&amp;#34;&lt;/span> &lt;span style="color:#66d9ef">WHERE&lt;/span> username &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39;user2&amp;#39;&lt;/span>), (&lt;span style="color:#66d9ef">SELECT&lt;/span> id &lt;span style="color:#66d9ef">FROM&lt;/span> &lt;span style="color:#66d9ef">host&lt;/span> &lt;span style="color:#66d9ef">WHERE&lt;/span> hostname &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39;host1&amp;#39;&lt;/span>), &lt;span style="color:#e6db74">&amp;#39;vps_user2_host1&amp;#39;&lt;/span>, &lt;span style="color:#e6db74">&amp;#39;{&amp;#34;disk_size&amp;#34;: 60}&amp;#39;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">-- user1 在 host2 上创建一个 VPS
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">INSERT&lt;/span> &lt;span style="color:#66d9ef">INTO&lt;/span> &lt;span style="color:#e6db74">&amp;#34;vps&amp;#34;&lt;/span> (user_id, host_id, name, sys_disk) &lt;span style="color:#66d9ef">VALUES&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ((&lt;span style="color:#66d9ef">SELECT&lt;/span> id &lt;span style="color:#66d9ef">FROM&lt;/span> &lt;span style="color:#e6db74">&amp;#34;user&amp;#34;&lt;/span> &lt;span style="color:#66d9ef">WHERE&lt;/span> username &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39;user1&amp;#39;&lt;/span>), (&lt;span style="color:#66d9ef">SELECT&lt;/span> id &lt;span style="color:#66d9ef">FROM&lt;/span> &lt;span style="color:#66d9ef">host&lt;/span> &lt;span style="color:#66d9ef">WHERE&lt;/span> hostname &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39;host2&amp;#39;&lt;/span>), &lt;span style="color:#e6db74">&amp;#39;vps_user1_host2&amp;#39;&lt;/span>, &lt;span style="color:#e6db74">&amp;#39;{&amp;#34;disk_size&amp;#34;: 70}&amp;#39;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">-- user2 在 host2 上创建一个 VPS
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">INSERT&lt;/span> &lt;span style="color:#66d9ef">INTO&lt;/span> &lt;span style="color:#e6db74">&amp;#34;vps&amp;#34;&lt;/span> (user_id, host_id, name, sys_disk) &lt;span style="color:#66d9ef">VALUES&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ((&lt;span style="color:#66d9ef">SELECT&lt;/span> id &lt;span style="color:#66d9ef">FROM&lt;/span> &lt;span style="color:#e6db74">&amp;#34;user&amp;#34;&lt;/span> &lt;span style="color:#66d9ef">WHERE&lt;/span> username &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39;user2&amp;#39;&lt;/span>), (&lt;span style="color:#66d9ef">SELECT&lt;/span> id &lt;span style="color:#66d9ef">FROM&lt;/span> &lt;span style="color:#66d9ef">host&lt;/span> &lt;span style="color:#66d9ef">WHERE&lt;/span> hostname &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39;host2&amp;#39;&lt;/span>), &lt;span style="color:#e6db74">&amp;#39;vps_user2_host2&amp;#39;&lt;/span>, &lt;span style="color:#e6db74">&amp;#39;{&amp;#34;disk_size&amp;#34;: 80}&amp;#39;&lt;/span>);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="关于-databasesql">
 关于 &lt;code>database/sql&lt;/code>
 &lt;a class="anchor" href="#%e5%85%b3%e4%ba%8e-databasesql">#&lt;/a>
&lt;/h2>
&lt;p>&lt;code>database/sql&lt;/code>提供了操作SQL数据库的通用接口, 需要结合&lt;code>database driver&lt;/code>同时使用, 这里是一些&lt;a href="https://go.dev/wiki/SQLDrivers">驱动列表&lt;/a>&lt;/p></description></item><item><title>解决Go应用在容器中的时区问题</title><link>/posts/solve-timezone-issue-in-go-application-in-container/</link><pubDate>Sat, 18 Feb 2023 16:12:01 +0800</pubDate><guid>/posts/solve-timezone-issue-in-go-application-in-container/</guid><description>&lt;h2 id="容器中的时区问题">
 容器中的时区问题
 &lt;a class="anchor" href="#%e5%ae%b9%e5%99%a8%e4%b8%ad%e7%9a%84%e6%97%b6%e5%8c%ba%e9%97%ae%e9%a2%98">#&lt;/a>
&lt;/h2>
&lt;p>应用直接运行在服务器上需要设置服务器时区为东八区，现在很多应用都是部署在容器中了，同样也是要设置容器镜像的时区。&lt;/p>
&lt;p>许多容器镜像默认时区为 &lt;code>UTC&lt;/code> (&lt;a href="https://zh.wikipedia.org/zh-hans/%E5%8D%8F%E8%B0%83%E4%B8%96%E7%95%8C%E6%97%B6">Coordinated Universal Time 协调世界时&lt;/a>)，比东八区慢八个小时，当程序涉及数据库写入操作或者日志记录等功能时就会有时间差。&lt;/p>
&lt;p>常规解决方案一般两大类&lt;/p>
&lt;ol>
&lt;li>build docker镜像时就把镜像内的时区设置为 &lt;code>Asia/Shanghai&lt;/code>&lt;/li>
&lt;li>运行容器时把本地时区正常的主机的时区配置文件挂载到容器。&lt;/li>
&lt;/ol>
&lt;h3 id="看一下-go-是如何读取时区文件并设置-timetime-的时区的">
 看一下 &lt;code>Go&lt;/code> 是如何读取时区文件并设置 &lt;code>time.Time&lt;/code> 的时区的
 &lt;a class="anchor" href="#%e7%9c%8b%e4%b8%80%e4%b8%8b-go-%e6%98%af%e5%a6%82%e4%bd%95%e8%af%bb%e5%8f%96%e6%97%b6%e5%8c%ba%e6%96%87%e4%bb%b6%e5%b9%b6%e8%ae%be%e7%bd%ae-timetime-%e7%9a%84%e6%97%b6%e5%8c%ba%e7%9a%84">#&lt;/a>
&lt;/h3>
&lt;p>&lt;code>Go&lt;/code> 源码 &lt;a href="https://github.com/golang/go/blob/master/src/time/zoneinfo_unix.go">src/time/zoneinfo_unix.go&lt;/a> 中代码和注释都很清晰👍&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-golang" data-lang="golang">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">package&lt;/span> &lt;span style="color:#a6e22e">time&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">import&lt;/span> (
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;syscall&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// Many systems use /usr/share/zoneinfo, Solaris 2 has&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// /usr/share/lib/zoneinfo, IRIX 6 has /usr/lib/locale/TZ,&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// NixOS has /etc/zoneinfo.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">var&lt;/span> &lt;span style="color:#a6e22e">platformZoneSources&lt;/span> = []&lt;span style="color:#66d9ef">string&lt;/span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;/usr/share/zoneinfo/&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;/usr/share/lib/zoneinfo/&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;/usr/lib/locale/TZ/&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;/etc/zoneinfo&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">initLocal&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// consult $TZ to find the time zone to use.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// no $TZ means use the system default /etc/localtime.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// $TZ=&amp;#34;&amp;#34; means use UTC.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// $TZ=&amp;#34;foo&amp;#34; or $TZ=&amp;#34;:foo&amp;#34; if foo is an absolute path, then the file pointed&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// by foo will be used to initialize timezone; otherwise, file&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// /usr/share/zoneinfo/foo will be used.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">tz&lt;/span>, &lt;span style="color:#a6e22e">ok&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">syscall&lt;/span>.&lt;span style="color:#a6e22e">Getenv&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;TZ&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">switch&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> !&lt;span style="color:#a6e22e">ok&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">z&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">loadLocation&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;localtime&amp;#34;&lt;/span>, []&lt;span style="color:#66d9ef">string&lt;/span>{&lt;span style="color:#e6db74">&amp;#34;/etc&amp;#34;&lt;/span>})
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">localLoc&lt;/span> = &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">z&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">localLoc&lt;/span>.&lt;span style="color:#a6e22e">name&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;Local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> &lt;span style="color:#a6e22e">tz&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">tz&lt;/span>[&lt;span style="color:#ae81ff">0&lt;/span>] &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#39;:&amp;#39;&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">tz&lt;/span> = &lt;span style="color:#a6e22e">tz&lt;/span>[&lt;span style="color:#ae81ff">1&lt;/span>:]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">tz&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#a6e22e">tz&lt;/span>[&lt;span style="color:#ae81ff">0&lt;/span>] &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#39;/&amp;#39;&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">z&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">loadLocation&lt;/span>(&lt;span style="color:#a6e22e">tz&lt;/span>, []&lt;span style="color:#66d9ef">string&lt;/span>{&lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span>}); &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">localLoc&lt;/span> = &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">z&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">tz&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#34;/etc/localtime&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">localLoc&lt;/span>.&lt;span style="color:#a6e22e">name&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;Local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">localLoc&lt;/span>.&lt;span style="color:#a6e22e">name&lt;/span> = &lt;span style="color:#a6e22e">tz&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">tz&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#a6e22e">tz&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;UTC&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">z&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">loadLocation&lt;/span>(&lt;span style="color:#a6e22e">tz&lt;/span>, &lt;span style="color:#a6e22e">platformZoneSources&lt;/span>); &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">localLoc&lt;/span> = &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">z&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Fall back to UTC.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">localLoc&lt;/span>.&lt;span style="color:#a6e22e">name&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;UTC&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>首先检查是否设置了 &lt;code>TZ&lt;/code> 环境变量&lt;/p></description></item><item><title>减小go程序编译后的体积</title><link>/posts/go-app-reduce-size/</link><pubDate>Mon, 22 Nov 2021 10:29:02 +0800</pubDate><guid>/posts/go-app-reduce-size/</guid><description>&lt;h2 id="编译经典程序">
 编译经典程序
 &lt;a class="anchor" href="#%e7%bc%96%e8%af%91%e7%bb%8f%e5%85%b8%e7%a8%8b%e5%ba%8f">#&lt;/a>
&lt;/h2>
&lt;h3 id="程序代码">
 程序代码
 &lt;a class="anchor" href="#%e7%a8%8b%e5%ba%8f%e4%bb%a3%e7%a0%81">#&lt;/a>
&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-golang" data-lang="golang">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">package&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#e6db74">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fmt&lt;/span>.&lt;span style="color:#a6e22e">Println&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;Hello World.&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="编译环境">
 编译环境
 &lt;a class="anchor" href="#%e7%bc%96%e8%af%91%e7%8e%af%e5%a2%83">#&lt;/a>
&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ go version
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>go version go1.16.7 linux/amd64
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="0-直接编译">
 0. 直接编译
 &lt;a class="anchor" href="#0-%e7%9b%b4%e6%8e%a5%e7%bc%96%e8%af%91">#&lt;/a>
&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ go build -o helloword main.go
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ ls -lh helloword 
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>-rwxrwxr-x &lt;span style="color:#ae81ff">1&lt;/span> gobai gobai 1.9M Nov &lt;span style="color:#ae81ff">23&lt;/span> 09:34 helloword
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="1-修改编译选项">
 1. 修改编译选项
 &lt;a class="anchor" href="#1-%e4%bf%ae%e6%94%b9%e7%bc%96%e8%af%91%e9%80%89%e9%a1%b9">#&lt;/a>
&lt;/h2>
&lt;p>除去编译时带的符号表和调试信息&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ go build -ldflags&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;-s -w&amp;#34;&lt;/span> -o helloword main.go
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ ls -lh helloword 
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>-rwxrwxr-x &lt;span style="color:#ae81ff">1&lt;/span> gobai gobai 1.3M Nov &lt;span style="color:#ae81ff">23&lt;/span> 09:38 helloword
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="2-使用-upx">
 2. 使用 &lt;code>UPX&lt;/code>
 &lt;a class="anchor" href="#2-%e4%bd%bf%e7%94%a8-upx">#&lt;/a>
&lt;/h2>
&lt;p>对直接编译出的二进制使用 &lt;a href="https://github.com/upx/upx">upx&lt;/a> 进一步压缩&lt;/p></description></item></channel></rss>