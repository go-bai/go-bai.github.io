<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>libvirt on gobai's blog</title><link>/posts/virt/libvirt/</link><description>Recent content in libvirt on gobai's blog</description><generator>Hugo</generator><language>en-us</language><atom:link href="/posts/virt/libvirt/index.xml" rel="self" type="application/rss+xml"/><item><title>Libvirt 使用笔记</title><link>/posts/libvirt/</link><pubDate>Sat, 27 Jul 2024 22:57:08 +0800</pubDate><guid>/posts/libvirt/</guid><description>&lt;h2 id="virsh-命令">
 &lt;code>virsh&lt;/code> 命令
 &lt;a class="anchor" href="#virsh-%e5%91%bd%e4%bb%a4">#&lt;/a>
&lt;/h2>
&lt;h3 id="virsh-domifaddr-查看虚拟机网卡ip">
 &lt;code>virsh domifaddr&lt;/code> 查看虚拟机网卡ip
 &lt;a class="anchor" href="#virsh-domifaddr-%e6%9f%a5%e7%9c%8b%e8%99%9a%e6%8b%9f%e6%9c%ba%e7%bd%91%e5%8d%a1ip">#&lt;/a>
&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># virsh domifaddr k3s-node01 --source lease&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Name MAC address Protocol Address
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>-------------------------------------------------------------------------------
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>通过arp获取网卡ip&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># virsh domifaddr k3s-node01 --source arp&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Name MAC address Protocol Address
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>-------------------------------------------------------------------------------
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> vnet18 52:54:00:0e:08:02 ipv4 192.168.1.248/0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>通过qemu guest agent获取网卡ip&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># virsh domifaddr k3s-node01 --source agent&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Name MAC address Protocol Address
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>-------------------------------------------------------------------------------
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> lo 00:00:00:00:00:00 ipv4 127.0.0.1/8
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> enp1s0 52:54:00:0e:08:02 ipv4 192.168.1.248/24
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> flannel.1 92:61:59:0c:29:90 ipv4 10.42.0.0/32
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cni0 42:fb:8d:3e:c1:a4 ipv4 10.42.0.1/24
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> vethde547696 da:18:a8:b2:ed:f0 N/A N/A
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> vethe1841f6e ce:79:fc:e1:1e:0b N/A N/A
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> veth464995dc 82:a9:3b:a6:b5:49 N/A N/A
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> veth2370e2ac 4a:c8:32:5c:fb:34 N/A N/A
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>创建虚拟机时使用 cloudinit 初始化</title><link>/posts/create-vm-with-cloudinit/</link><pubDate>Mon, 01 Jul 2024 01:56:57 +0800</pubDate><guid>/posts/create-vm-with-cloudinit/</guid><description>&lt;h2 id="cloudinit-介绍">
 cloudinit 介绍
 &lt;a class="anchor" href="#cloudinit-%e4%bb%8b%e7%bb%8d">#&lt;/a>
&lt;/h2>
&lt;blockquote>
&lt;p>用于在新建的虚拟机中进行时间设置、密码设置、扩展根文件系统所在分区、设置主机名、运行脚本、安装软件包等初始化设置&lt;/p>&lt;/blockquote>
&lt;h2 id="宿主机配置脚本">
 宿主机配置脚本
 &lt;a class="anchor" href="#%e5%ae%bf%e4%b8%bb%e6%9c%ba%e9%85%8d%e7%bd%ae%e8%84%9a%e6%9c%ac">#&lt;/a>
&lt;/h2>
&lt;p>此脚本会用来在 &lt;code>/var/lib/libvirt/disks/${VM}/cloudinit&lt;/code> 目录生成 cloudinit iso 镜像&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>cat &lt;span style="color:#e6db74">&amp;lt;&amp;lt;EOFALL &amp;gt; /usr/bin/gen-cloudinit-iso
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">set -eux
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">CLOUD_INIT_DIR=&amp;#34;/var/lib/libvirt/disks/\${VM}/cloudinit&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">FILENAME=&amp;#34;\${CLOUD_INIT_DIR}/init.iso&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">mkdir -p \${CLOUD_INIT_DIR}
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">cat &amp;lt;&amp;lt;EOF &amp;gt; \${CLOUD_INIT_DIR}/meta-data
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">instance-id: \${VM}
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">local-hostname: \${VM}
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">EOF
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># 更多配置参照 https://cloudinit.readthedocs.io/en/latest/explanation/format.html
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">cat &amp;lt;&amp;lt;EOF &amp;gt; \${CLOUD_INIT_DIR}/user-data
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">#cloud-config
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">EOF
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># 参考 kubevirt /pkg/cloud-init/cloud-init.go:defaultIsoFunc
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">xorrisofs -output \$FILENAME -volid cidata -joliet -rock -partition_cyl_align on \${CLOUD_INIT_DIR}/user-data \${CLOUD_INIT_DIR}/meta-data
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">EOFALL&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>chmod +x /usr/bin/gen-cloudinit-iso
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="创建虚拟机时使用-cloudinit">
 创建虚拟机时使用 cloudinit
 &lt;a class="anchor" href="#%e5%88%9b%e5%bb%ba%e8%99%9a%e6%8b%9f%e6%9c%ba%e6%97%b6%e4%bd%bf%e7%94%a8-cloudinit">#&lt;/a>
&lt;/h2>
&lt;p>创建虚拟机之前创建 cloudinit iso, 并通过 cdrom 挂载&lt;/p></description></item></channel></rss>