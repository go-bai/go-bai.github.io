<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Virt Manager | gobai's blog</title>
<link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/xcode.min.css rel=stylesheet></head><body><nav><ul class=menu><li><a href=/>Home</a></li><li><a href=/about/>About</a></li><li><a href=/tags/>Tags</a></li><li><a href=/index.xml>Subscribe</a></li></ul><hr></nav><div class=article-meta><h1><span class=title>Virt Manager</span></h1><h4 class=date>2023/09/23</h4><p class=terms>Tags: <a href=/tags/hypervisor>hypervisor</a> <a href=/tags/kvm>kvm</a> <a href=/tags/qemu>qemu</a> <a href=/tags/virsh>virsh</a></p></div><main><h3 id=环境>环境</h3><h4 id=操作系统-ubuntu-22043-lts-desktop>操作系统 Ubuntu 22.04.3 LTS Desktop</h4><pre><code class=language-bash>➜  ~ cat /etc/os-release 
PRETTY_NAME=&quot;Ubuntu 22.04.3 LTS&quot;
NAME=&quot;Ubuntu&quot;
VERSION_ID=&quot;22.04&quot;
VERSION=&quot;22.04.3 LTS (Jammy Jellyfish)&quot;
VERSION_CODENAME=jammy
ID=ubuntu
ID_LIKE=debian
HOME_URL=&quot;https://www.ubuntu.com/&quot;
SUPPORT_URL=&quot;https://help.ubuntu.com/&quot;
BUG_REPORT_URL=&quot;https://bugs.launchpad.net/ubuntu/&quot;
PRIVACY_POLICY_URL=&quot;https://www.ubuntu.com/legal/terms-and-policies/privacy-policy&quot;
UBUNTU_CODENAME=jammy
</code></pre><h4 id=网络环境>网络环境</h4><p>已创建<code>bridged network</code>, <a href=../creating-a-bridged-network-with-netplan-on-ubuntu-22-04/>Creating a bridged network with netplan on Ubuntu 22.04</a></p><h3 id=安装配置>安装配置</h3><h4 id=安装>安装</h4><pre><code class=language-bash>sudo apt install virt-manager qemu bridge-utils -y
</code></pre><h4 id=配置-bridge-类型网络>配置 <code>bridge</code> 类型网络</h4><p>TODO</p><h4 id=修改libvirtd配置文件并重启>修改<code>libvirtd</code>配置文件并重启</h4><p><code>sudo vim /etc/libvirt/qemu.conf</code></p><pre><code class=language-diff>- #user = &quot;root&quot;
+ user = &quot;gobai&quot;

- #group = &quot;root&quot;
+ group = &quot;gobai&quot;
</code></pre><p><code>sudo systemctl restart libvirtd</code></p><h4 id=启动-virt-manager>启动 <code>virt-manager</code></h4><pre><code class=language-bash>sudo virt-manager
</code></pre><h3 id=运行-openwrt>运行 openwrt</h3><p>现有镜像文件在<code>Documents</code>目录下</p><pre><code class=language-bash>➜  Documents ls -lh
total 855M
-rw-r--r-- 1 gobai gobai 855M  9月 23 23:06 openwrt-x86-64-generic-ext4-combined-efi.img
</code></pre><p>查看镜像文件类型并转换为 qcow2</p><pre><code class=language-bash>➜  Documents qemu-img info openwrt-x86-64-generic-ext4-combined-efi.img 
image: openwrt-x86-64-generic-ext4-combined-efi.img
file format: raw
virtual size: 854 MiB (895778304 bytes)
disk size: 854 MiB
➜  Documents qemu-img convert -f raw -O qcow2 openwrt-x86-64-generic-ext4-combined-efi.img openwrt-x86-64-generic-ext4-combined-efi.qcow2
➜  Documents qemu-img info openwrt-x86-64-generic-ext4-combined-efi.qcow2 
image: openwrt-x86-64-generic-ext4-combined-efi.qcow2
file format: qcow2
virtual size: 854 MiB (895778304 bytes)
disk size: 544 MiB
cluster_size: 65536
Format specific information:
    compat: 1.1
    compression type: zlib
    lazy refcounts: false
    refcount bits: 16
    corrupt: false
    extended l2: false
</code></pre><p>修改镜像文件所属用户和用户组为<code>libvirt-qemu</code></p><pre><code class=language-bash>➜  Documents sudo chown libvirt-qemu:libvirt-qemu openwrt-x86-64-generic-ext4-combined-efi.qcow2 
[sudo] password for gobai: 
➜  Documents ls -lh
total 1.4G
-rw-r--r-- 1 gobai        gobai        855M  9月 23 23:06 openwrt-x86-64-generic-ext4-combined-efi.img
-rw-r--r-- 1 libvirt-qemu libvirt-qemu 545M  9月 23 23:31 openwrt-x86-64-generic-ext4-combined-efi.qcow2
</code></pre><h4 id=virt-viewer连接vm><code>virt-viewer</code>连接vm</h4><pre><code class=language-bash>sudo virt-viewer --connect qemu:///session openwrt
</code></pre><h4 id=virsh命令行工具><code>virsh</code>命令行工具</h4><pre><code class=language-bash># ========== domain ==========
# 虚机列表
virsh list --all
# 关闭虚机
virsh shutdown domain
# 启动虚机
virsh start domain

# ========== network ==========
# 网络列表
virsh net-list

# ========== other ==========
# 更改root用户密码, 此命令会和虚机内的qemu guest agent(qga)进程通过串口进行交互
virsh set-user-password --domain domain --user root --password 123456
</code></pre></main><footer><script defer src=https://cdn.jsdelivr.net/npm/@xiee/utils/js/center-img.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script>hljs.configure({languages:[]}),hljs.highlightAll()</script><hr>© <a href=https://blog.gocn.top>gobai</a> 2021 &ndash; 2023 | <a href=https://github.com/go-bai>Github</a></footer></body></html>