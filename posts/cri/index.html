<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  关于 CRI
  #

CRI 全称为 Container Runtime Interface, 容器运行时接口
https://github.com/kubernetes/cri-api
containerd 的 criService 有实现下面这个 RuntimeServiceServer
// RuntimeServiceServer is the server API for RuntimeService service.
type RuntimeServiceServer interface {
	// Version returns the runtime name, runtime version, and runtime API version.
	Version(context.Context, *VersionRequest) (*VersionResponse, error)
	// RunPodSandbox creates and starts a pod-level sandbox. Runtimes must ensure
	// the sandbox is in the ready state on success.
	RunPodSandbox(context.Context, *RunPodSandboxRequest) (*RunPodSandboxResponse, error)
	// StopPodSandbox stops any running process that is part of the sandbox and
	// reclaims network resources (e.g., IP addresses) allocated to the sandbox.
	// If there are any running containers in the sandbox, they must be forcibly
	// terminated.
	// This call is idempotent, and must not return an error if all relevant
	// resources have already been reclaimed. kubelet will call StopPodSandbox
	// at least once before calling RemovePodSandbox. It will also attempt to
	// reclaim resources eagerly, as soon as a sandbox is not needed. Hence,
	// multiple StopPodSandbox calls are expected.
	StopPodSandbox(context.Context, *StopPodSandboxRequest) (*StopPodSandboxResponse, error)
	// RemovePodSandbox removes the sandbox. If there are any running containers
	// in the sandbox, they must be forcibly terminated and removed.
	// This call is idempotent, and must not return an error if the sandbox has
	// already been removed.
	RemovePodSandbox(context.Context, *RemovePodSandboxRequest) (*RemovePodSandboxResponse, error)
	// PodSandboxStatus returns the status of the PodSandbox. If the PodSandbox is not
	// present, returns an error.
	PodSandboxStatus(context.Context, *PodSandboxStatusRequest) (*PodSandboxStatusResponse, error)
	// ListPodSandbox returns a list of PodSandboxes.
	ListPodSandbox(context.Context, *ListPodSandboxRequest) (*ListPodSandboxResponse, error)
	// CreateContainer creates a new container in specified PodSandbox
	CreateContainer(context.Context, *CreateContainerRequest) (*CreateContainerResponse, error)
	// StartContainer starts the container.
	StartContainer(context.Context, *StartContainerRequest) (*StartContainerResponse, error)
	// StopContainer stops a running container with a grace period (i.e., timeout).
	// This call is idempotent, and must not return an error if the container has
	// already been stopped.
	// The runtime must forcibly kill the container after the grace period is
	// reached.
	StopContainer(context.Context, *StopContainerRequest) (*StopContainerResponse, error)
	// RemoveContainer removes the container. If the container is running, the
	// container must be forcibly removed.
	// This call is idempotent, and must not return an error if the container has
	// already been removed.
	RemoveContainer(context.Context, *RemoveContainerRequest) (*RemoveContainerResponse, error)
	// ListContainers lists all containers by filters.
	ListContainers(context.Context, *ListContainersRequest) (*ListContainersResponse, error)
	// ContainerStatus returns status of the container. If the container is not
	// present, returns an error.
	ContainerStatus(context.Context, *ContainerStatusRequest) (*ContainerStatusResponse, error)
	// UpdateContainerResources updates ContainerConfig of the container synchronously.
	// If runtime fails to transactionally update the requested resources, an error is returned.
	UpdateContainerResources(context.Context, *UpdateContainerResourcesRequest) (*UpdateContainerResourcesResponse, error)
	// ReopenContainerLog asks runtime to reopen the stdout/stderr log file
	// for the container. This is often called after the log file has been
	// rotated. If the container is not running, container runtime can choose
	// to either create a new log file and return nil, or return an error.
	// Once it returns error, new container log file MUST NOT be created.
	ReopenContainerLog(context.Context, *ReopenContainerLogRequest) (*ReopenContainerLogResponse, error)
	// ExecSync runs a command in a container synchronously.
	ExecSync(context.Context, *ExecSyncRequest) (*ExecSyncResponse, error)
	// Exec prepares a streaming endpoint to execute a command in the container.
	Exec(context.Context, *ExecRequest) (*ExecResponse, error)
	// Attach prepares a streaming endpoint to attach to a running container.
	Attach(context.Context, *AttachRequest) (*AttachResponse, error)
	// PortForward prepares a streaming endpoint to forward ports from a PodSandbox.
	PortForward(context.Context, *PortForwardRequest) (*PortForwardResponse, error)
	// ContainerStats returns stats of the container. If the container does not
	// exist, the call returns an error.
	ContainerStats(context.Context, *ContainerStatsRequest) (*ContainerStatsResponse, error)
	// ListContainerStats returns stats of all running containers.
	ListContainerStats(context.Context, *ListContainerStatsRequest) (*ListContainerStatsResponse, error)
	// PodSandboxStats returns stats of the pod sandbox. If the pod sandbox does not
	// exist, the call returns an error.
	PodSandboxStats(context.Context, *PodSandboxStatsRequest) (*PodSandboxStatsResponse, error)
	// ListPodSandboxStats returns stats of the pod sandboxes matching a filter.
	ListPodSandboxStats(context.Context, *ListPodSandboxStatsRequest) (*ListPodSandboxStatsResponse, error)
	// UpdateRuntimeConfig updates the runtime configuration based on the given request.
	UpdateRuntimeConfig(context.Context, *UpdateRuntimeConfigRequest) (*UpdateRuntimeConfigResponse, error)
	// Status returns the status of the runtime.
	Status(context.Context, *StatusRequest) (*StatusResponse, error)
	// CheckpointContainer checkpoints a container
	CheckpointContainer(context.Context, *CheckpointContainerRequest) (*CheckpointContainerResponse, error)
	// GetContainerEvents gets container events from the CRI runtime
	GetContainerEvents(*GetEventsRequest, RuntimeService_GetContainerEventsServer) error
	// ListMetricDescriptors gets the descriptors for the metrics that will be returned in ListPodSandboxMetrics.
	// This list should be static at startup: either the client and server restart together when
	// adding or removing metrics descriptors, or they should not change.
	// Put differently, if ListPodSandboxMetrics references a name that is not described in the initial
	// ListMetricDescriptors call, then the metric will not be broadcasted.
	ListMetricDescriptors(context.Context, *ListMetricDescriptorsRequest) (*ListMetricDescriptorsResponse, error)
	// ListPodSandboxMetrics gets pod sandbox metrics from CRI Runtime
	ListPodSandboxMetrics(context.Context, *ListPodSandboxMetricsRequest) (*ListPodSandboxMetricsResponse, error)
	// RuntimeConfig returns configuration information of the runtime.
	// A couple of notes:
	//   - The RuntimeConfigRequest object is not to be confused with the contents of UpdateRuntimeConfigRequest.
	//     The former is for having runtime tell Kubelet what to do, the latter vice versa.
	//   - It is the expectation of the Kubelet that these fields are static for the lifecycle of the Kubelet.
	//     The Kubelet will not re-request the RuntimeConfiguration after startup, and CRI implementations should
	//     avoid updating them without a full node reboot.
	RuntimeConfig(context.Context, *RuntimeConfigRequest) (*RuntimeConfigResponse, error)
}
"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="/posts/cri/"><meta property="og:site_name" content="gobai's notes"><meta property="og:title" content="CRI 工作原理"><meta property="og:description" content="关于 CRI # CRI 全称为 Container Runtime Interface, 容器运行时接口
https://github.com/kubernetes/cri-api
containerd 的 criService 有实现下面这个 RuntimeServiceServer
// RuntimeServiceServer is the server API for RuntimeService service. type RuntimeServiceServer interface { // Version returns the runtime name, runtime version, and runtime API version. Version(context.Context, *VersionRequest) (*VersionResponse, error) // RunPodSandbox creates and starts a pod-level sandbox. Runtimes must ensure // the sandbox is in the ready state on success. RunPodSandbox(context.Context, *RunPodSandboxRequest) (*RunPodSandboxResponse, error) // StopPodSandbox stops any running process that is part of the sandbox and // reclaims network resources (e.g., IP addresses) allocated to the sandbox. // If there are any running containers in the sandbox, they must be forcibly // terminated. // This call is idempotent, and must not return an error if all relevant // resources have already been reclaimed. kubelet will call StopPodSandbox // at least once before calling RemovePodSandbox. It will also attempt to // reclaim resources eagerly, as soon as a sandbox is not needed. Hence, // multiple StopPodSandbox calls are expected. StopPodSandbox(context.Context, *StopPodSandboxRequest) (*StopPodSandboxResponse, error) // RemovePodSandbox removes the sandbox. If there are any running containers // in the sandbox, they must be forcibly terminated and removed. // This call is idempotent, and must not return an error if the sandbox has // already been removed. RemovePodSandbox(context.Context, *RemovePodSandboxRequest) (*RemovePodSandboxResponse, error) // PodSandboxStatus returns the status of the PodSandbox. If the PodSandbox is not // present, returns an error. PodSandboxStatus(context.Context, *PodSandboxStatusRequest) (*PodSandboxStatusResponse, error) // ListPodSandbox returns a list of PodSandboxes. ListPodSandbox(context.Context, *ListPodSandboxRequest) (*ListPodSandboxResponse, error) // CreateContainer creates a new container in specified PodSandbox CreateContainer(context.Context, *CreateContainerRequest) (*CreateContainerResponse, error) // StartContainer starts the container. StartContainer(context.Context, *StartContainerRequest) (*StartContainerResponse, error) // StopContainer stops a running container with a grace period (i.e., timeout). // This call is idempotent, and must not return an error if the container has // already been stopped. // The runtime must forcibly kill the container after the grace period is // reached. StopContainer(context.Context, *StopContainerRequest) (*StopContainerResponse, error) // RemoveContainer removes the container. If the container is running, the // container must be forcibly removed. // This call is idempotent, and must not return an error if the container has // already been removed. RemoveContainer(context.Context, *RemoveContainerRequest) (*RemoveContainerResponse, error) // ListContainers lists all containers by filters. ListContainers(context.Context, *ListContainersRequest) (*ListContainersResponse, error) // ContainerStatus returns status of the container. If the container is not // present, returns an error. ContainerStatus(context.Context, *ContainerStatusRequest) (*ContainerStatusResponse, error) // UpdateContainerResources updates ContainerConfig of the container synchronously. // If runtime fails to transactionally update the requested resources, an error is returned. UpdateContainerResources(context.Context, *UpdateContainerResourcesRequest) (*UpdateContainerResourcesResponse, error) // ReopenContainerLog asks runtime to reopen the stdout/stderr log file // for the container. This is often called after the log file has been // rotated. If the container is not running, container runtime can choose // to either create a new log file and return nil, or return an error. // Once it returns error, new container log file MUST NOT be created. ReopenContainerLog(context.Context, *ReopenContainerLogRequest) (*ReopenContainerLogResponse, error) // ExecSync runs a command in a container synchronously. ExecSync(context.Context, *ExecSyncRequest) (*ExecSyncResponse, error) // Exec prepares a streaming endpoint to execute a command in the container. Exec(context.Context, *ExecRequest) (*ExecResponse, error) // Attach prepares a streaming endpoint to attach to a running container. Attach(context.Context, *AttachRequest) (*AttachResponse, error) // PortForward prepares a streaming endpoint to forward ports from a PodSandbox. PortForward(context.Context, *PortForwardRequest) (*PortForwardResponse, error) // ContainerStats returns stats of the container. If the container does not // exist, the call returns an error. ContainerStats(context.Context, *ContainerStatsRequest) (*ContainerStatsResponse, error) // ListContainerStats returns stats of all running containers. ListContainerStats(context.Context, *ListContainerStatsRequest) (*ListContainerStatsResponse, error) // PodSandboxStats returns stats of the pod sandbox. If the pod sandbox does not // exist, the call returns an error. PodSandboxStats(context.Context, *PodSandboxStatsRequest) (*PodSandboxStatsResponse, error) // ListPodSandboxStats returns stats of the pod sandboxes matching a filter. ListPodSandboxStats(context.Context, *ListPodSandboxStatsRequest) (*ListPodSandboxStatsResponse, error) // UpdateRuntimeConfig updates the runtime configuration based on the given request. UpdateRuntimeConfig(context.Context, *UpdateRuntimeConfigRequest) (*UpdateRuntimeConfigResponse, error) // Status returns the status of the runtime. Status(context.Context, *StatusRequest) (*StatusResponse, error) // CheckpointContainer checkpoints a container CheckpointContainer(context.Context, *CheckpointContainerRequest) (*CheckpointContainerResponse, error) // GetContainerEvents gets container events from the CRI runtime GetContainerEvents(*GetEventsRequest, RuntimeService_GetContainerEventsServer) error // ListMetricDescriptors gets the descriptors for the metrics that will be returned in ListPodSandboxMetrics. // This list should be static at startup: either the client and server restart together when // adding or removing metrics descriptors, or they should not change. // Put differently, if ListPodSandboxMetrics references a name that is not described in the initial // ListMetricDescriptors call, then the metric will not be broadcasted. ListMetricDescriptors(context.Context, *ListMetricDescriptorsRequest) (*ListMetricDescriptorsResponse, error) // ListPodSandboxMetrics gets pod sandbox metrics from CRI Runtime ListPodSandboxMetrics(context.Context, *ListPodSandboxMetricsRequest) (*ListPodSandboxMetricsResponse, error) // RuntimeConfig returns configuration information of the runtime. // A couple of notes: // - The RuntimeConfigRequest object is not to be confused with the contents of UpdateRuntimeConfigRequest. // The former is for having runtime tell Kubelet what to do, the latter vice versa. // - It is the expectation of the Kubelet that these fields are static for the lifecycle of the Kubelet. // The Kubelet will not re-request the RuntimeConfiguration after startup, and CRI implementations should // avoid updating them without a full node reboot. RuntimeConfig(context.Context, *RuntimeConfigRequest) (*RuntimeConfigResponse, error) }"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-11-17T20:30:12+08:00"><meta property="article:modified_time" content="2025-03-11T11:08:31+08:00"><title>CRI 工作原理 | gobai's notes</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=/posts/cri/><link rel=stylesheet href=/book.min.434035e7885c7f5d12818bd9f111cf1a0925c6fb78382667381c3d5eda3fb4f1.css><script defer src=/fuse.min.js></script><script defer src=/en.search.min.e7b268b2fc8cddef7d68b0c3b4edcd15970b328b841409c741508178e24ad80b.js></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><img src=/favicon.ico alt=Logo class=book-icon><span>gobai's notes</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><span>Golang</span><ul><li><input type=checkbox id=section-98d0efdb3baf67b2c791a7fd1bbf6ca1 class=toggle>
<label for=section-98d0efdb3baf67b2c791a7fd1bbf6ca1 class="flex justify-between"><a role=button>语言基础</a></label><ul><li><a href=/posts/golang-memory-escape/>内存逃逸</a></li><li><a href=/posts/golang-gc/>GC 垃圾回收</a></li><li><a href=/posts/golang-make-and-new/>make 与 new 区别</a></li><li><a href=/posts/golang-gmp/>GMP 模型</a></li></ul></li><li><input type=checkbox id=section-42d8c4148cb4c5a3e3d8addaded05197 class=toggle>
<label for=section-42d8c4148cb4c5a3e3d8addaded05197 class="flex justify-between"><a role=button>数据结构</a></label><ul><li><a href=/posts/golang-chan/>Channel</a></li></ul></li><li><input type=checkbox id=section-1ca588caf6263863db394d8b5e8e27c7 class=toggle>
<label for=section-1ca588caf6263863db394d8b5e8e27c7 class="flex justify-between"><a role=button>标准库</a></label><ul></ul></li><li><input type=checkbox id=section-241d5557475d85971162af97f6d52ccb class=toggle>
<label for=section-241d5557475d85971162af97f6d52ccb class="flex justify-between"><a role=button>三方库</a></label><ul><li><a href=/posts/sqlx-vs-xorm/>sqlx vs xorm</a></li></ul></li><li><input type=checkbox id=section-fcb09aa495225b08f1e972b051618bb6 class=toggle>
<label for=section-fcb09aa495225b08f1e972b051618bb6 class="flex justify-between"><a role=button>其他</a></label><ul><li><a href=/posts/solve-timezone-issue-in-go-application-in-container/>Go应用在容器中的时区</a></li><li><a href=/posts/go-app-reduce-size/>减小go程序编译后的体积</a></li></ul></li></ul></li><li><input type=checkbox id=section-f91fe725fab4dcbef0dd504359ff7b63 class=toggle>
<label for=section-f91fe725fab4dcbef0dd504359ff7b63 class="flex justify-between"><a role=button>Linux</a></label><ul><li><input type=checkbox id=section-176ad016ae09a9f0440dca17617492cb class=toggle>
<label for=section-176ad016ae09a9f0440dca17617492cb class="flex justify-between"><a role=button>Network</a></label><ul><li><a href=/posts/linux-iptables/>Linux iptables</a></li><li><a href=/posts/linux-bridge/>Linux Bridge</a></li><li><a href=/posts/wireless-to-wired-network/>无线转有线网络</a></li><li><a href=/posts/openwrt/>OpenWrt</a></li><li><a href=/posts/dhclient/>dhclient</a></li><li><a href=/posts/creating-a-bridged-network-with-netplan-on-ubuntu-22-04/>在 Ubuntu 22.04 使用 netplan 创建桥接网络</a></li></ul></li><li><input type=checkbox id=section-33e3a313f4903205bd4597f5f4045be9 class=toggle>
<label for=section-33e3a313f4903205bd4597f5f4045be9 class="flex justify-between"><a role=button>OS</a></label><ul><li><a href=/posts/linux-boot-process-bios/>Linux 启动流程 (BIOS)</a></li><li><a href=/posts/multi-bootable-usb/>Multi-Bootable USB</a></li></ul></li><li><input type=checkbox id=section-3b63411eed8d0cecdd3250e70daaaace class=toggle>
<label for=section-3b63411eed8d0cecdd3250e70daaaace class="flex justify-between"><a role=button>Storage</a></label><ul><li><a href=/posts/partitioning-disks/>Linux 磁盘分区</a></li><li><a href=/posts/inode/>Linux 文件系统之 inode</a></li><li><a href=/posts/delete-partition-and-expand-another/>删除分区并扩容另一个分区和根文件系统</a></li></ul></li><li><input type=checkbox id=section-244a9b038b0e0aa873cb558da61a18b1 class=toggle>
<label for=section-244a9b038b0e0aa873cb558da61a18b1 class="flex justify-between"><a role=button>其他</a></label><ul><li><a href=/posts/filebrowser/>Filebrowser 安装</a></li><li><a href=/posts/rclone/>Rclone 使用笔记</a></li><li><a href=/posts/shell-script/>Shell Script</a></li><li><a href=/posts/ubuntu-config/>Ubuntu Config</a></li><li><a href=/posts/systemd-journal/>About Systemd</a></li></ul></li></ul></li><li><input type=checkbox id=section-db6ac5e9808e911c643d4dada0e07ebd class=toggle checked>
<label for=section-db6ac5e9808e911c643d4dada0e07ebd class="flex justify-between"><a role=button>Kubernetes</a></label><ul><li><a href=/posts/k8s-informer/>k8s informer 介绍</a></li><li><a href=/posts/flannel/>深入了解 Kubernetes CNI 网络插件 Flannel</a></li><li><a href=/posts/kube-scheduler/>Kube Scheduler</a></li><li><a href=/posts/cri/ class=active>CRI 工作原理</a></li><li><a href=/posts/cni/>CNI 工作原理</a></li><li><a href=/posts/csi/>CSI 工作原理</a></li><li><a href=/posts/builing-multi-platform-container-images-guide/>构建多平台容器镜像</a></li><li><a href=/posts/rke2/>RKE2 安装 k8s 集群</a></li><li><a href=/posts/controller-runtime/>Controller Runtime</a></li><li><input type=checkbox id=section-8edd6114a0c1ce280c6628362e538ba7 class=toggle>
<label for=section-8edd6114a0c1ce280c6628362e538ba7 class="flex justify-between"><a role=button>问题记录</a></label><ul><li><a href=/posts/failed-to-reserve-sandbox-name/>failed to reserve sandbox name</a></li></ul></li></ul></li><li><input type=checkbox id=section-45ed28834a9c7fe37d3e4d15606fec65 class=toggle>
<label for=section-45ed28834a9c7fe37d3e4d15606fec65 class="flex justify-between"><a role=button>Database</a></label><ul><li><a href=/posts/sqlite3/>SQLite3</a></li></ul></li><li><span>Virtualization</span><ul><li><input type=checkbox id=section-7c5a43731ddd199a055dda51c8660688 class=toggle>
<label for=section-7c5a43731ddd199a055dda51c8660688 class="flex justify-between"><a role=button>KubeVirt</a></label><ul><li><a href=/posts/kubevirt-sidecar/>Kubevirt Hook Sidecar</a></li></ul></li><li><input type=checkbox id=section-01c36c077fb673b3c49c2a334c82e286 class=toggle>
<label for=section-01c36c077fb673b3c49c2a334c82e286 class="flex justify-between"><a role=button>libvirt</a></label><ul><li><a href=/posts/libvirt/>Libvirt 使用笔记</a></li><li><a href=/posts/create-vm-with-cloudinit/>创建虚拟机时使用 cloudinit 初始化</a></li></ul></li></ul></li><li><input type=checkbox id=section-51c4e989897e79573c9215830bc89f6c class=toggle>
<label for=section-51c4e989897e79573c9215830bc89f6c class="flex justify-between"><a role=button>Prometheus</a></label><ul><li><a href=/posts/prometheus-basics/>Prometheus 基础</a></li><li><a href=/posts/kube-prometheus-stack/>kube-prometheus-stack 安装</a></li><li><a href=/posts/node-exporter/>node-exporter 安装</a></li></ul></li><li><input type=checkbox id=section-3dd648d0479248759f2c07b8d5ee80be class=toggle>
<label for=section-3dd648d0479248759f2c07b8d5ee80be class="flex justify-between"><a role=button>Ceph</a></label><ul><li><a href=/posts/rook-ceph/>安装 Rook Ceph</a></li></ul></li><li><input type=checkbox id=section-bceaf15d0fd4d92497330a70b95e69d1 class=toggle>
<label for=section-bceaf15d0fd4d92497330a70b95e69d1 class="flex justify-between"><a role=button>其他</a></label><ul><li><a href=/posts/vscode-extensions/>Vscode Extensions</a></li><li><a href=/posts/macos-config/>MacOS Config</a></li><li><a href=/posts/vim-tricks/>Vim Tricks</a></li><li><a href=/posts/git-tricks/>Git Tricks</a></li></ul></li><li class=book-section-flat><span>&lt;&lt; 链接 >></span><ul><li><a href=/posts/about/>关于我</a></li><li><a href=/posts/links/>友链</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>CRI 工作原理</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#关于-cri>关于 CRI</a></li></ul></nav></aside></header><article class="markdown book-post"><h1>CRI 工作原理</h1><div class="flex align-center text-small book-post-date"><img src=/svg/calendar.svg class=book-icon alt>
<span>2024-11-17</span></div><div class=book-post-content><h2 id=关于-cri>关于 CRI
<a class=anchor href=#%e5%85%b3%e4%ba%8e-cri>#</a></h2><p>CRI 全称为 <code>Container Runtime Interface</code>, 容器运行时接口</p><p><a href=https://github.com/kubernetes/cri-api>https://github.com/kubernetes/cri-api</a></p><p>containerd 的 <code>criService</code> 有实现下面这个 <code>RuntimeServiceServer</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#75715e>// RuntimeServiceServer is the server API for RuntimeService service.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>RuntimeServiceServer</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Version returns the runtime name, runtime version, and runtime API version.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Version</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>VersionRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>VersionResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// RunPodSandbox creates and starts a pod-level sandbox. Runtimes must ensure</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// the sandbox is in the ready state on success.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>RunPodSandbox</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>RunPodSandboxRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>RunPodSandboxResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// StopPodSandbox stops any running process that is part of the sandbox and</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// reclaims network resources (e.g., IP addresses) allocated to the sandbox.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// If there are any running containers in the sandbox, they must be forcibly</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// terminated.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// This call is idempotent, and must not return an error if all relevant</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// resources have already been reclaimed. kubelet will call StopPodSandbox</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// at least once before calling RemovePodSandbox. It will also attempt to</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// reclaim resources eagerly, as soon as a sandbox is not needed. Hence,</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// multiple StopPodSandbox calls are expected.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>StopPodSandbox</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>StopPodSandboxRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>StopPodSandboxResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// RemovePodSandbox removes the sandbox. If there are any running containers</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// in the sandbox, they must be forcibly terminated and removed.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// This call is idempotent, and must not return an error if the sandbox has</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// already been removed.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>RemovePodSandbox</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>RemovePodSandboxRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>RemovePodSandboxResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// PodSandboxStatus returns the status of the PodSandbox. If the PodSandbox is not</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// present, returns an error.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PodSandboxStatus</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>PodSandboxStatusRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>PodSandboxStatusResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ListPodSandbox returns a list of PodSandboxes.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ListPodSandbox</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ListPodSandboxRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ListPodSandboxResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// CreateContainer creates a new container in specified PodSandbox</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>CreateContainer</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>CreateContainerRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>CreateContainerResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// StartContainer starts the container.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>StartContainer</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>StartContainerRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>StartContainerResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// StopContainer stops a running container with a grace period (i.e., timeout).</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// This call is idempotent, and must not return an error if the container has</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// already been stopped.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// The runtime must forcibly kill the container after the grace period is</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// reached.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>StopContainer</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>StopContainerRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>StopContainerResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// RemoveContainer removes the container. If the container is running, the</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// container must be forcibly removed.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// This call is idempotent, and must not return an error if the container has</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// already been removed.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>RemoveContainer</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>RemoveContainerRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>RemoveContainerResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ListContainers lists all containers by filters.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ListContainers</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ListContainersRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ListContainersResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ContainerStatus returns status of the container. If the container is not</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// present, returns an error.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ContainerStatus</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ContainerStatusRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ContainerStatusResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// UpdateContainerResources updates ContainerConfig of the container synchronously.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// If runtime fails to transactionally update the requested resources, an error is returned.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>UpdateContainerResources</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>UpdateContainerResourcesRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>UpdateContainerResourcesResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ReopenContainerLog asks runtime to reopen the stdout/stderr log file</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// for the container. This is often called after the log file has been</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// rotated. If the container is not running, container runtime can choose</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// to either create a new log file and return nil, or return an error.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Once it returns error, new container log file MUST NOT be created.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ReopenContainerLog</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ReopenContainerLogRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ReopenContainerLogResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ExecSync runs a command in a container synchronously.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ExecSync</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ExecSyncRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ExecSyncResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Exec prepares a streaming endpoint to execute a command in the container.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Exec</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ExecRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ExecResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Attach prepares a streaming endpoint to attach to a running container.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Attach</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>AttachRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>AttachResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// PortForward prepares a streaming endpoint to forward ports from a PodSandbox.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PortForward</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>PortForwardRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>PortForwardResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ContainerStats returns stats of the container. If the container does not</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// exist, the call returns an error.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ContainerStats</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ContainerStatsRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ContainerStatsResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ListContainerStats returns stats of all running containers.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ListContainerStats</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ListContainerStatsRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ListContainerStatsResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// PodSandboxStats returns stats of the pod sandbox. If the pod sandbox does not</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// exist, the call returns an error.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PodSandboxStats</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>PodSandboxStatsRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>PodSandboxStatsResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ListPodSandboxStats returns stats of the pod sandboxes matching a filter.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ListPodSandboxStats</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ListPodSandboxStatsRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ListPodSandboxStatsResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// UpdateRuntimeConfig updates the runtime configuration based on the given request.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>UpdateRuntimeConfig</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>UpdateRuntimeConfigRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>UpdateRuntimeConfigResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Status returns the status of the runtime.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Status</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>StatusRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>StatusResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// CheckpointContainer checkpoints a container</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>CheckpointContainer</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>CheckpointContainerRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>CheckpointContainerResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// GetContainerEvents gets container events from the CRI runtime</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>GetContainerEvents</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>GetEventsRequest</span>, <span style=color:#a6e22e>RuntimeService_GetContainerEventsServer</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ListMetricDescriptors gets the descriptors for the metrics that will be returned in ListPodSandboxMetrics.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// This list should be static at startup: either the client and server restart together when</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// adding or removing metrics descriptors, or they should not change.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Put differently, if ListPodSandboxMetrics references a name that is not described in the initial</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ListMetricDescriptors call, then the metric will not be broadcasted.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ListMetricDescriptors</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ListMetricDescriptorsRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ListMetricDescriptorsResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ListPodSandboxMetrics gets pod sandbox metrics from CRI Runtime</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ListPodSandboxMetrics</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ListPodSandboxMetricsRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ListPodSandboxMetricsResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// RuntimeConfig returns configuration information of the runtime.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// A couple of notes:</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//   - The RuntimeConfigRequest object is not to be confused with the contents of UpdateRuntimeConfigRequest.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//     The former is for having runtime tell Kubelet what to do, the latter vice versa.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//   - It is the expectation of the Kubelet that these fields are static for the lifecycle of the Kubelet.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//     The Kubelet will not re-request the RuntimeConfiguration after startup, and CRI implementations should</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//     avoid updating them without a full node reboot.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>RuntimeConfig</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>RuntimeConfigRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>RuntimeConfigResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/go-bai/go-bai.github.io/commit/52e9a317e2ea3a0785571698961c607c1b640acd title='Last modified by go-bai | 2025-03-11' target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt>
<span>2025-03-11</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#关于-cri>关于 CRI</a></li></ul></nav></div></aside></main></body></html>