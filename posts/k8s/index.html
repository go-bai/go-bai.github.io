<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="/posts/k8s/"><meta property="og:site_name" content="gobai's notes"><meta property="og:title" content="Kubernetes"><meta property="og:locale" content="en_us"><meta property="og:type" content="website"><title>Kubernetes | gobai's notes</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=/posts/k8s/><link rel=stylesheet href=/book.min.434035e7885c7f5d12818bd9f111cf1a0925c6fb78382667381c3d5eda3fb4f1.css><script defer src=/fuse.min.js></script><script defer src=/en.search.min.c566b30ae65cfa992fb45dc6a60d2c9ab0efc283058a1214d8e1f84d6a5df65d.js></script><link rel=alternate type=application/rss+xml href=/posts/k8s/index.xml title="gobai's notes"></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><img src=/favicon.ico alt=Logo class=book-icon><span>gobai's notes</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><span>Golang</span><ul><li><input type=checkbox id=section-98d0efdb3baf67b2c791a7fd1bbf6ca1 class=toggle>
<label for=section-98d0efdb3baf67b2c791a7fd1bbf6ca1 class="flex justify-between"><a role=button>语言基础</a></label><ul><li><a href=/posts/golang-memory-escape/>内存逃逸</a></li><li><a href=/posts/golang-gc/>GC 垃圾回收</a></li><li><a href=/posts/golang-make-and-new/>make 与 new 区别</a></li><li><a href=/posts/golang-gmp/>GMP 模型</a></li></ul></li><li><input type=checkbox id=section-42d8c4148cb4c5a3e3d8addaded05197 class=toggle>
<label for=section-42d8c4148cb4c5a3e3d8addaded05197 class="flex justify-between"><a role=button>数据结构</a></label><ul><li><a href=/posts/golang-chan/>Channel</a></li></ul></li><li><input type=checkbox id=section-1ca588caf6263863db394d8b5e8e27c7 class=toggle>
<label for=section-1ca588caf6263863db394d8b5e8e27c7 class="flex justify-between"><a role=button>标准库</a></label><ul></ul></li><li><input type=checkbox id=section-241d5557475d85971162af97f6d52ccb class=toggle>
<label for=section-241d5557475d85971162af97f6d52ccb class="flex justify-between"><a role=button>三方库</a></label><ul><li><a href=/posts/sqlx-vs-xorm/>sqlx vs xorm</a></li></ul></li><li><input type=checkbox id=section-fcb09aa495225b08f1e972b051618bb6 class=toggle>
<label for=section-fcb09aa495225b08f1e972b051618bb6 class="flex justify-between"><a role=button>其他</a></label><ul><li><a href=/posts/solve-timezone-issue-in-go-application-in-container/>Go应用在容器中的时区</a></li><li><a href=/posts/go-app-reduce-size/>减小go程序编译后的体积</a></li></ul></li></ul></li><li><input type=checkbox id=section-f91fe725fab4dcbef0dd504359ff7b63 class=toggle>
<label for=section-f91fe725fab4dcbef0dd504359ff7b63 class="flex justify-between"><a role=button>Linux</a></label><ul><li><input type=checkbox id=section-176ad016ae09a9f0440dca17617492cb class=toggle>
<label for=section-176ad016ae09a9f0440dca17617492cb class="flex justify-between"><a role=button>Network</a></label><ul><li><a href=/posts/linux-iptables/>Linux iptables</a></li><li><a href=/posts/linux-bridge/>Linux Bridge</a></li><li><a href=/posts/wireless-to-wired-network/>无线转有线网络</a></li><li><a href=/posts/openwrt/>OpenWrt</a></li><li><a href=/posts/dhclient/>dhclient</a></li><li><a href=/posts/creating-a-bridged-network-with-netplan-on-ubuntu-22-04/>在 Ubuntu 22.04 使用 netplan 创建桥接网络</a></li></ul></li><li><input type=checkbox id=section-33e3a313f4903205bd4597f5f4045be9 class=toggle>
<label for=section-33e3a313f4903205bd4597f5f4045be9 class="flex justify-between"><a role=button>OS</a></label><ul><li><a href=/posts/linux-boot-process-bios/>Linux 启动流程 (BIOS)</a></li><li><a href=/posts/multi-bootable-usb/>Multi-Bootable USB</a></li></ul></li><li><input type=checkbox id=section-3b63411eed8d0cecdd3250e70daaaace class=toggle>
<label for=section-3b63411eed8d0cecdd3250e70daaaace class="flex justify-between"><a role=button>Storage</a></label><ul><li><a href=/posts/partitioning-disks/>Linux 磁盘分区</a></li><li><a href=/posts/inode/>Linux 文件系统之 inode</a></li><li><a href=/posts/delete-partition-and-expand-another/>删除分区并扩容另一个分区和根文件系统</a></li></ul></li><li><input type=checkbox id=section-244a9b038b0e0aa873cb558da61a18b1 class=toggle>
<label for=section-244a9b038b0e0aa873cb558da61a18b1 class="flex justify-between"><a role=button>其他</a></label><ul><li><a href=/posts/filebrowser/>Filebrowser 部署</a></li><li><a href=/posts/rclone/>Rclone 使用笔记</a></li><li><a href=/posts/shell-script/>Shell Script</a></li><li><a href=/posts/ubuntu-config/>Ubuntu Config</a></li><li><a href=/posts/systemd-journal/>About Systemd</a></li></ul></li></ul></li><li><input type=checkbox id=section-db6ac5e9808e911c643d4dada0e07ebd class=toggle checked>
<label for=section-db6ac5e9808e911c643d4dada0e07ebd class="flex justify-between"><a role=button class=active>Kubernetes</a></label><ul><li><a href=/posts/k8s-informer/>k8s informer 介绍</a></li><li><a href=/posts/flannel/>深入了解 Kubernetes CNI 网络插件 Flannel</a></li><li><a href=/posts/kube-scheduler/>Kube Scheduler</a></li><li><a href=/posts/cri/>CRI 工作原理</a></li><li><a href=/posts/cni/>CNI 工作原理</a></li><li><a href=/posts/csi/>CSI 工作原理</a></li><li><a href=/posts/builing-multi-platform-container-images-guide/>构建多平台容器镜像</a></li><li><a href=/posts/rke2/>RKE2 安装 k8s 集群</a></li><li><a href=/posts/controller-runtime/>Controller Runtime</a></li><li><input type=checkbox id=section-8edd6114a0c1ce280c6628362e538ba7 class=toggle>
<label for=section-8edd6114a0c1ce280c6628362e538ba7 class="flex justify-between"><a role=button>问题记录</a></label><ul><li><a href=/posts/failed-to-reserve-sandbox-name/>failed to reserve sandbox name</a></li></ul></li></ul></li><li><input type=checkbox id=section-45ed28834a9c7fe37d3e4d15606fec65 class=toggle>
<label for=section-45ed28834a9c7fe37d3e4d15606fec65 class="flex justify-between"><a role=button>Database</a></label><ul><li><a href=/posts/sqlite3/>SQLite3</a></li></ul></li><li><span>Virtualization</span><ul><li><input type=checkbox id=section-7c5a43731ddd199a055dda51c8660688 class=toggle>
<label for=section-7c5a43731ddd199a055dda51c8660688 class="flex justify-between"><a role=button>KubeVirt</a></label><ul><li><a href=/posts/kubevirt-sidecar/>Kubevirt Hook Sidecar</a></li></ul></li><li><input type=checkbox id=section-01c36c077fb673b3c49c2a334c82e286 class=toggle>
<label for=section-01c36c077fb673b3c49c2a334c82e286 class="flex justify-between"><a role=button>libvirt</a></label><ul><li><a href=/posts/libvirt/>Libvirt 使用笔记</a></li><li><a href=/posts/create-vm-with-cloudinit/>创建虚拟机时使用 cloudinit 初始化</a></li></ul></li></ul></li><li><input type=checkbox id=section-51c4e989897e79573c9215830bc89f6c class=toggle>
<label for=section-51c4e989897e79573c9215830bc89f6c class="flex justify-between"><a role=button>Prometheus</a></label><ul><li><a href=/posts/prometheus-basics/>Prometheus 基础</a></li><li><a href=/posts/kube-prometheus-stack/>kube-prometheus-stack 安装</a></li><li><a href=/posts/node-exporter/>node-exporter 安装</a></li></ul></li><li><input type=checkbox id=section-3dd648d0479248759f2c07b8d5ee80be class=toggle>
<label for=section-3dd648d0479248759f2c07b8d5ee80be class="flex justify-between"><a role=button>Ceph</a></label><ul><li><a href=/posts/rook-ceph/>安装 Rook Ceph</a></li></ul></li><li><input type=checkbox id=section-bceaf15d0fd4d92497330a70b95e69d1 class=toggle>
<label for=section-bceaf15d0fd4d92497330a70b95e69d1 class="flex justify-between"><a role=button>其他</a></label><ul><li><a href=/posts/vscode-extensions/>Vscode Extensions</a></li><li><a href=/posts/macos-config/>MacOS Config</a></li><li><a href=/posts/vim-tricks/>Vim Tricks</a></li><li><a href=/posts/git-tricks/>Git Tricks</a></li></ul></li><li class=book-section-flat><span>&lt;&lt; 链接 >></span><ul><li><a href=/posts/about/>关于我</a></li><li><a href=/posts/links/>友链</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>Kubernetes</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav><ul><li class=book-section-flat><strong>Categories</strong><ul></ul></li><li class=book-section-flat><strong>Tags</strong><ul></ul></li></ul></nav></aside></header><article class="markdown book-post"><h2><a href=/posts/k8s-informer/>k8s informer 介绍</a></h2><div class="flex align-center text-small book-post-date"><img src=/svg/calendar.svg class=book-icon alt>
<span>2025-02-23</span></div><div class=book-post-content><p><code>informer</code> 提供一个保持更新的 k8s 资源的本地缓存。</p><h2 id=informer><code>informer</code>
<a class=anchor href=#informer>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang></code></pre></div></div></article><article class="markdown book-post"><h2><a href=/posts/flannel/>深入了解 Kubernetes CNI 网络插件 Flannel</a></h2><div class="flex align-center text-small book-post-date"><img src=/svg/calendar.svg class=book-icon alt>
<span>2025-01-01</span></div><div class=book-post-content><h2 id=关于>关于
<a class=anchor href=#%e5%85%b3%e4%ba%8e>#</a></h2><p><a href=https://github.com/flannel-io/flannel>flannel</a> 是由 CoreOS 开发的一个简单易用的容器网络插件</p><p>网络是 k8s 中至关重要的一部分, 这里以简单的 flannel 为例做深入分析</p><h3 id=工作原理>工作原理
<a class=anchor href=#%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86>#</a></h3><blockquote><p>以下介绍在 chart 方式部署的 flannel</p></blockquote><p>flanneld 进程以 daemonset/kube-flannel-ds 方式运行在所有 node 上, 负责从提前配置好的网络池中分配子网租约 (subnet lease) 给 node.</p><p>flanneld 使用 k8s api 或者 etcd 存储网络配置、分配的子网和任何补充数据(如 node 的 public ip), 在 k8s 中使用一般不会单独提供 etcd 去存储这些数据.</p><ul><li>网络配置存储在 configmap 中, kube-flannel ns 下的 cm/kube-flannel-cfg 中</li><li>分配的子网存储在 PodCIDR 中</li></ul><p>几个名词解释:</p><ol><li><code>subnet</code>: 对应 <code>node.spec.podCIDR</code>。</li><li><code>backend</code>: 负责 <code>node</code> 之间 <code>pod</code> 通讯的后端。</li></ol><p>flanneld 进程通过监听 <code>node</code> 资源来生成 <code>subnet event</code>, 然后在对应 <code>backend</code> 的 <code>handleSubnetEvents</code> 方法中处理逻辑，对于 <code>vxlan backend</code> 主要是按顺序设置 <code>arp</code>, <code>fdb</code> 和 <code>route</code> 来实现pod跨节点通讯。</p><a href=/posts/flannel/>...</a></div></article><article class="markdown book-post"><h2><a href=/posts/kube-scheduler/>Kube Scheduler</a></h2><div class="flex align-center text-small book-post-date"><img src=/svg/calendar.svg class=book-icon alt>
<span>2024-12-17</span></div><div class=book-post-content><p>RKE2 自定义<a href=https://kubernetes.io/zh-cn/docs/reference/scheduling/config/>调度器配置</a></p><ol><li>创建调度器配置文件</li></ol><p><code>NodeResourcesFit</code> 是一个调度插件, 检查节点是否拥有 Pod 请求的所有资源, 得分可以使用以下三种策略之一:
<code>LeastAllocated</code> (默认)、<code>MostAllocated</code> 和 <code>RequestedToCapacityRatio</code></p><p>实现了多个扩展点: <code>preFilter</code>、<code>filter</code>、<code>preScore</code>、<code>score</code></p><p>我这里自定义使用 <code>MostAllocated</code> 策略, 优选分配比率较高的节点</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># /etc/rancher/rke2/kube-scheduler-config.yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>kubescheduler.config.k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>KubeSchedulerConfiguration</span>
</span></span><span style=display:flex><span><span style=color:#f92672>clientConnection</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>kubeconfig</span>: <span style=color:#ae81ff>/var/lib/rancher/rke2/server/cred/scheduler.kubeconfig</span>
</span></span><span style=display:flex><span><span style=color:#f92672>profiles</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>schedulerName</span>: <span style=color:#ae81ff>default-scheduler</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>pluginConfig</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>NodeResourcesFit</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>args</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>scoringStrategy</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>type</span>: <span style=color:#ae81ff>MostAllocated</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>              - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>cpu</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>weight</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>              - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>memory</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>weight</span>: <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><ol start=2><li>修改 rke2 配置文件</li></ol><p>修改 <code>/etc/rancher/rke2/config.yaml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>kube-scheduler-arg:
</span></span><span style=display:flex><span><span style=color:#a6e22e>+ - config=/etc/rancher/rke2/kube-scheduler-config.yaml
</span></span></span></code></pre></div><ol start=3><li>重启 rke2-server</li></ol><p>会重新生成 kube-scheduler 的 static pod manifest 文件 <code>/var/lib/rancher/rke2/agent/pod-manifests/kube-scheduler.yaml</code></p><p>会挂载 <code>/etc/rancher/rke2/kube-scheduler-config.yaml</code> 文件到 pod 中</p></div></article><article class="markdown book-post"><h2><a href=/posts/cri/>CRI 工作原理</a></h2><div class="flex align-center text-small book-post-date"><img src=/svg/calendar.svg class=book-icon alt>
<span>2024-11-17</span></div><div class=book-post-content><h2 id=关于-cri>关于 CRI
<a class=anchor href=#%e5%85%b3%e4%ba%8e-cri>#</a></h2><p>CRI 全称为 <code>Container Runtime Interface</code>, 容器运行时接口</p><p><a href=https://github.com/kubernetes/cri-api>https://github.com/kubernetes/cri-api</a></p><p>containerd 的 <code>criService</code> 有实现下面这个 <code>RuntimeServiceServer</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#75715e>// RuntimeServiceServer is the server API for RuntimeService service.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>RuntimeServiceServer</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Version returns the runtime name, runtime version, and runtime API version.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Version</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>VersionRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>VersionResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// RunPodSandbox creates and starts a pod-level sandbox. Runtimes must ensure</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// the sandbox is in the ready state on success.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>RunPodSandbox</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>RunPodSandboxRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>RunPodSandboxResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// StopPodSandbox stops any running process that is part of the sandbox and</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// reclaims network resources (e.g., IP addresses) allocated to the sandbox.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// If there are any running containers in the sandbox, they must be forcibly</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// terminated.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// This call is idempotent, and must not return an error if all relevant</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// resources have already been reclaimed. kubelet will call StopPodSandbox</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// at least once before calling RemovePodSandbox. It will also attempt to</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// reclaim resources eagerly, as soon as a sandbox is not needed. Hence,</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// multiple StopPodSandbox calls are expected.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>StopPodSandbox</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>StopPodSandboxRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>StopPodSandboxResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// RemovePodSandbox removes the sandbox. If there are any running containers</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// in the sandbox, they must be forcibly terminated and removed.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// This call is idempotent, and must not return an error if the sandbox has</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// already been removed.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>RemovePodSandbox</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>RemovePodSandboxRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>RemovePodSandboxResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// PodSandboxStatus returns the status of the PodSandbox. If the PodSandbox is not</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// present, returns an error.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PodSandboxStatus</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>PodSandboxStatusRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>PodSandboxStatusResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ListPodSandbox returns a list of PodSandboxes.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ListPodSandbox</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ListPodSandboxRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ListPodSandboxResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// CreateContainer creates a new container in specified PodSandbox</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>CreateContainer</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>CreateContainerRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>CreateContainerResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// StartContainer starts the container.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>StartContainer</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>StartContainerRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>StartContainerResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// StopContainer stops a running container with a grace period (i.e., timeout).</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// This call is idempotent, and must not return an error if the container has</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// already been stopped.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// The runtime must forcibly kill the container after the grace period is</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// reached.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>StopContainer</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>StopContainerRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>StopContainerResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// RemoveContainer removes the container. If the container is running, the</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// container must be forcibly removed.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// This call is idempotent, and must not return an error if the container has</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// already been removed.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>RemoveContainer</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>RemoveContainerRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>RemoveContainerResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ListContainers lists all containers by filters.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ListContainers</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ListContainersRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ListContainersResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ContainerStatus returns status of the container. If the container is not</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// present, returns an error.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ContainerStatus</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ContainerStatusRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ContainerStatusResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// UpdateContainerResources updates ContainerConfig of the container synchronously.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// If runtime fails to transactionally update the requested resources, an error is returned.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>UpdateContainerResources</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>UpdateContainerResourcesRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>UpdateContainerResourcesResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ReopenContainerLog asks runtime to reopen the stdout/stderr log file</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// for the container. This is often called after the log file has been</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// rotated. If the container is not running, container runtime can choose</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// to either create a new log file and return nil, or return an error.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Once it returns error, new container log file MUST NOT be created.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ReopenContainerLog</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ReopenContainerLogRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ReopenContainerLogResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ExecSync runs a command in a container synchronously.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ExecSync</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ExecSyncRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ExecSyncResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Exec prepares a streaming endpoint to execute a command in the container.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Exec</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ExecRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ExecResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Attach prepares a streaming endpoint to attach to a running container.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Attach</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>AttachRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>AttachResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// PortForward prepares a streaming endpoint to forward ports from a PodSandbox.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PortForward</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>PortForwardRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>PortForwardResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ContainerStats returns stats of the container. If the container does not</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// exist, the call returns an error.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ContainerStats</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ContainerStatsRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ContainerStatsResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ListContainerStats returns stats of all running containers.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ListContainerStats</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ListContainerStatsRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ListContainerStatsResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// PodSandboxStats returns stats of the pod sandbox. If the pod sandbox does not</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// exist, the call returns an error.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PodSandboxStats</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>PodSandboxStatsRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>PodSandboxStatsResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ListPodSandboxStats returns stats of the pod sandboxes matching a filter.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ListPodSandboxStats</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ListPodSandboxStatsRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ListPodSandboxStatsResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// UpdateRuntimeConfig updates the runtime configuration based on the given request.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>UpdateRuntimeConfig</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>UpdateRuntimeConfigRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>UpdateRuntimeConfigResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Status returns the status of the runtime.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Status</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>StatusRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>StatusResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// CheckpointContainer checkpoints a container</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>CheckpointContainer</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>CheckpointContainerRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>CheckpointContainerResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// GetContainerEvents gets container events from the CRI runtime</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>GetContainerEvents</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>GetEventsRequest</span>, <span style=color:#a6e22e>RuntimeService_GetContainerEventsServer</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ListMetricDescriptors gets the descriptors for the metrics that will be returned in ListPodSandboxMetrics.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// This list should be static at startup: either the client and server restart together when</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// adding or removing metrics descriptors, or they should not change.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Put differently, if ListPodSandboxMetrics references a name that is not described in the initial</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ListMetricDescriptors call, then the metric will not be broadcasted.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ListMetricDescriptors</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ListMetricDescriptorsRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ListMetricDescriptorsResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ListPodSandboxMetrics gets pod sandbox metrics from CRI Runtime</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ListPodSandboxMetrics</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ListPodSandboxMetricsRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ListPodSandboxMetricsResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// RuntimeConfig returns configuration information of the runtime.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// A couple of notes:</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//   - The RuntimeConfigRequest object is not to be confused with the contents of UpdateRuntimeConfigRequest.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//     The former is for having runtime tell Kubelet what to do, the latter vice versa.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//   - It is the expectation of the Kubelet that these fields are static for the lifecycle of the Kubelet.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//     The Kubelet will not re-request the RuntimeConfiguration after startup, and CRI implementations should</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//     avoid updating them without a full node reboot.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>RuntimeConfig</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>RuntimeConfigRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>RuntimeConfigResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article><article class="markdown book-post"><h2><a href=/posts/cni/>CNI 工作原理</a></h2><div class="flex align-center text-small book-post-date"><img src=/svg/calendar.svg class=book-icon alt>
<span>2024-11-17</span></div><div class=book-post-content><h2 id=关于-cni>关于 CNI
<a class=anchor href=#%e5%85%b3%e4%ba%8e-cni>#</a></h2><p>CNI 全称 <code>Container Network Interface</code>, 容器网络接口, cni 插件是可执行文件, 一般位于 <code>/opt/cni/bin/</code> 目录</p><p>在 k8s 中, kubelet 调用 cri 创建 sandbox 时(RunPodSandbox)会先去创建 network namespace, 然后创建 pause 和 其他容器并将容器加入到同一个 network namespace 中</p><p>cni spec 文档: <a href=https://www.cni.dev/docs/spec/>https://www.cni.dev/docs/spec/</a></p><p>有如下<a href=https://www.cni.dev/docs/spec/#parameters>环境变量参数</a>:</p><ul><li><code>CNI_COMMAND</code>: 对应操作 <code>ADD</code>, <code>DEL</code>, <code>CHECK</code>, or <code>VERSION</code>.</li><li><code>CNI_CONTAINERID</code>: 容器 id</li><li><code>CNI_NETNS</code>: 如 <code>/var/run/netns/[nsname]</code></li><li><code>CNI_IFNAME</code>: 要在容器中创建的接口名称, 一般容器中都是 <code>eth0</code></li><li><code>CNI_ARGS</code>: 额外的 kv 参数, 如 <code>FOO=BAR;ABC=123</code></li><li><code>CNI_PATH</code>: 搜索 cni plugin 可执行文件的目录</li></ul><h2 id=插件分析>插件分析
<a class=anchor href=#%e6%8f%92%e4%bb%b6%e5%88%86%e6%9e%90>#</a></h2><h3 id=bridge>bridge
<a class=anchor href=#bridge>#</a></h3><p>主要是 <code>cmdAdd</code> 和 <code>cmdDel</code> 两个函数, 对应 CNI spec 中的 <code>ADD</code> 和 <code>DEL</code> 两个主要操作</p><a href=/posts/cni/>...</a></div></article><article class="markdown book-post"><h2><a href=/posts/csi/>CSI 工作原理</a></h2><div class="flex align-center text-small book-post-date"><img src=/svg/calendar.svg class=book-icon alt>
<span>2024-11-04</span></div><div class=book-post-content><h2 id=关于-csi>关于 CSI
<a class=anchor href=#%e5%85%b3%e4%ba%8e-csi>#</a></h2><p>CSI 全称为 <code>Container Storage Interface</code>, 容器存储接口</p><p>要实现一个第三方的 csi driver 需要实现下面的 gRPC service <a href=https://github.com/container-storage-interface/spec/blob/master/lib/go/csi/csi_grpc.pb.go>csi spec</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#75715e>// 如果 NodeServer 和 ControllerServer 对应服务运行在不同 pod 中, 那么两个服务都要实现 IdentityServer</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>IdentityServer</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 用来获取插件名称</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>GetPluginInfo</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>GetPluginInfoRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>GetPluginInfoResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>GetPluginCapabilities</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>GetPluginCapabilitiesRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>GetPluginCapabilitiesResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Probe</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ProbeRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ProbeResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mustEmbedUnimplementedIdentityServer</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ControllerServer</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 创建 volume, 如 ceph 创建一个 rbd 或者 hostpath 创建一个目录</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CreateVolume</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>CreateVolumeRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>CreateVolumeResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 删除 volume, 如 ceph 删除一个 rbd 或者 hostpath 删除一个目录</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DeleteVolume</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>DeleteVolumeRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>DeleteVolumeResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 将 volume attach 到 node 上, 如 rbd 通过 rbd map 命令 attach, 成功后 node 上会多出一个 rbdx 的 block 设备</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ControllerPublishVolume</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ControllerPublishVolumeRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ControllerPublishVolumeResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 将 volume 从 node 上 detach, 如 rbd 通过 rbd unmap 命令 detach</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ControllerUnpublishVolume</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ControllerUnpublishVolumeRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ControllerUnpublishVolumeResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ValidateVolumeCapabilities</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ValidateVolumeCapabilitiesRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ValidateVolumeCapabilitiesResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 列出所有 volume</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ListVolumes</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ListVolumesRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ListVolumesResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>GetCapacity</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>GetCapacityRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>GetCapacityResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ControllerGetCapabilities</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ControllerGetCapabilitiesRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ControllerGetCapabilitiesResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CreateSnapshot</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>CreateSnapshotRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>CreateSnapshotResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DeleteSnapshot</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>DeleteSnapshotRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>DeleteSnapshotResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ListSnapshots</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ListSnapshotsRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ListSnapshotsResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ControllerExpandVolume</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ControllerExpandVolumeRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ControllerExpandVolumeResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ControllerGetVolume</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ControllerGetVolumeRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ControllerGetVolumeResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ControllerModifyVolume</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ControllerModifyVolumeRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ControllerModifyVolumeResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mustEmbedUnimplementedControllerServer</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 这些会被 kubelet 调用</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>NodeServer</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// format (如果没format), mount 到 node 的 global directory</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>NodeStageVolume</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>NodeStageVolumeRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>NodeStageVolumeResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// umount</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>NodeUnstageVolume</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>NodeUnstageVolumeRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>NodeUnstageVolumeResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// mount --bind 到 pod directory</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>NodePublishVolume</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>NodePublishVolumeRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>NodePublishVolumeResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// umount --bind</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>NodeUnpublishVolume</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>NodeUnpublishVolumeRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>NodeUnpublishVolumeResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>NodeGetVolumeStats</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>NodeGetVolumeStatsRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>NodeGetVolumeStatsResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>NodeExpandVolume</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>NodeExpandVolumeRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>NodeExpandVolumeResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>NodeGetCapabilities</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>NodeGetCapabilitiesRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>NodeGetCapabilitiesResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>NodeGetInfo</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>NodeGetInfoRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>NodeGetInfoResponse</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mustEmbedUnimplementedNodeServer</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=关于-sidecar-containers>关于 Sidecar Containers
<a class=anchor href=#%e5%85%b3%e4%ba%8e-sidecar-containers>#</a></h2><p><a href=https://kubernetes-csi.github.io/docs/sidecar-containers.html>Sidecar Containers</a> 是一系列标准容器，用于简化 CSI 插件的开发和部署</p><a href=/posts/csi/>...</a></div></article><article class="markdown book-post"><h2><a href=/posts/builing-multi-platform-container-images-guide/>构建多平台容器镜像</a></h2><div class="flex align-center text-small book-post-date"><img src=/svg/calendar.svg class=book-icon alt>
<span>2024-10-13</span></div><div class=book-post-content><blockquote><p>构建多平台容器镜像</p></blockquote><h2 id=docker-buildx-插件子命令>Docker buildx 插件/子命令
<a class=anchor href=#docker-buildx-%e6%8f%92%e4%bb%b6%e5%ad%90%e5%91%bd%e4%bb%a4>#</a></h2><p><a href=https://github.com/docker/buildx>buildx</a> 是 Docker 的一个 CLI 插件，用于扩展来自于 <a href=https://github.com/moby/buildkit>Moby BuildKit</a> 项目的构建功能。</p><p>注意：buildx 需要 Docker 19.03 或更高版本。</p><h2 id=buildkit>BuildKit
<a class=anchor href=#buildkit>#</a></h2><p>BuildKit是一个build引擎，它接收一个配置文件（Dockerfile），并转化成一个制品（容器镜像或其他制品）。相较与传统的build具有多阶段并发构建、更好的layer缓存支持等优点，Dockerfile中的RUN指令会被runc执行。</p><p>Docker Engine 从 <a href=https://docs.docker.com/engine/release-notes/23.0/#2300>23.0.0</a> 版本开始默认在Linux上使用Buildx和BuildKit为builder。</p><h3 id=builder-a-buildkit-daemon>Builder: a BuildKit daemon
<a class=anchor href=#builder-a-buildkit-daemon>#</a></h3><ul><li><a href=https://docs.docker.com/build/builders/>Builders介绍</a></li></ul><p>一个 builder 是一个 BuildKit 守护进程，BuildKit是build引擎，它解决Dockerfile中的构建步骤，以生成容器镜像或其他制品。</p><h3 id=build-drivers>Build drivers
<a class=anchor href=#build-drivers>#</a></h3><p>Build 驱动有多种，例如 <code>docker</code>、<code>docker-container</code>、<code>kubernetes</code>、<code>remote</code> 等。</p><ul><li><code>docker</code> 使用捆绑在Docker守护进程中的BuildKit库。默认的Builder使用的该驱动。</li><li><code>docker-container</code> 使用Docker创建一个专用的BuildKit容器。</li><li><code>kubernetes</code> 在Kubernetes集群中创建BuildKit pods。</li><li><code>remote</code> 直接连接到手动管理的BuildKit守护进程。</li></ul><div style=text-align:center>Build Drivers Comparison</div><table><thead><tr><th>Feature</th><th>docker</th><th>docker-container</th><th>kubernetes</th><th>remote</th></tr></thead><tbody><tr><td>Automatically load image</td><td>✅</td><td></td><td></td><td></td></tr><tr><td>Cache export</td><td>✓*</td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td>Tarball output</td><td></td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td>Multi-arch images</td><td></td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td>BuildKit configuration</td><td></td><td>✅</td><td></td><td>Managed externally</td></tr></tbody></table><div style=text-align:center>* The docker driver doesn't support all cache export options</div><h3 id=默认的-builder-实例>默认的 Builder 实例
<a class=anchor href=#%e9%bb%98%e8%ae%a4%e7%9a%84-builder-%e5%ae%9e%e4%be%8b>#</a></h3><p>docker engine 会自动创建一个默认的 builder 实例，例如 <code>default</code>。默认的驱动是 <code>docker</code>，不支持多平台构建。</p><a href=/posts/builing-multi-platform-container-images-guide/>...</a></div></article><article class="markdown book-post"><h2><a href=/posts/k8s-namespace/>K8s Namespace</a></h2><div class="flex align-center text-small book-post-date"><img src=/svg/calendar.svg class=book-icon alt>
<span>2024-08-05</span></div><div class=book-post-content></div></article><article class="markdown book-post"><h2><a href=/posts/k8s-cgroup/>K8s Cgroup</a></h2><div class="flex align-center text-small book-post-date"><img src=/svg/calendar.svg class=book-icon alt>
<span>2024-08-05</span></div><div class=book-post-content></div></article><article class="markdown book-post"><h2><a href=/posts/rke2/>RKE2 安装 k8s 集群</a></h2><div class="flex align-center text-small book-post-date"><img src=/svg/calendar.svg class=book-icon alt>
<span>2024-07-01</span></div><div class=book-post-content><p>根据<a href=../creating-a-bridged-network-with-netplan-on-ubuntu-22-04/>创建 bridge 网络</a>和<a href=../create-vm-with-cloudinit/>创建虚拟机时使用 cloudinit 初始化</a>创建虚拟机, 并配置静态ip如下</p><table><thead><tr><th>主机名</th><th>配置</th><th>ip (域名)</th><th>系统盘 / 数据盘</th></tr></thead><tbody><tr><td>k8s-node01</td><td>8核16G</td><td>192.168.1.218 (<code>lb.k8s.lan</code>)</td><td>50GB / 100GB*1</td></tr><tr><td>k8s-node02</td><td>8核16G</td><td>192.168.1.219</td><td>50GB / 100GB*1</td></tr><tr><td>k8s-node03</td><td>8核16G</td><td>192.168.1.220</td><td>50GB / 100GB*1</td></tr></tbody></table><h2 id=安装-rke2>安装 RKE2
<a class=anchor href=#%e5%ae%89%e8%a3%85-rke2>#</a></h2><h3 id=安装第一个-server-节点>安装第一个 server 节点
<a class=anchor href=#%e5%ae%89%e8%a3%85%e7%ac%ac%e4%b8%80%e4%b8%aa-server-%e8%8a%82%e7%82%b9>#</a></h3><p>在 k8s-node01 节点执行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 初始化 rke2 配置文件</span>
</span></span><span style=display:flex><span>mkdir -p /etc/rancher/rke2
</span></span><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;EOF &gt; /etc/rancher/rke2/config.yaml
</span></span></span><span style=display:flex><span><span style=color:#e6db74>tls-san:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  - lb.k8s.lan
</span></span></span><span style=display:flex><span><span style=color:#e6db74>write-kubeconfig-mode: &#34;0600&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>disable-cloud-controller: true
</span></span></span><span style=display:flex><span><span style=color:#e6db74># cni 单独部署, 如无特殊需求, 这里也可以直接指定 flannel 或 calico
</span></span></span><span style=display:flex><span><span style=color:#e6db74>cni: none
</span></span></span><span style=display:flex><span><span style=color:#e6db74>debug: true
</span></span></span><span style=display:flex><span><span style=color:#e6db74># 指定 kube-scheduler 自定义参数, 会自动覆盖到 /var/lib/rancher/rke2/agent/pod-manifests/kube-scheduler.yaml
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kube-scheduler-arg:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  - v=4
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  - bind-address=0.0.0.0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kube-controller-manager-arg:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  - bind-address=0.0.0.0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>etcd-expose-metrics: true
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl -sfL https://rancher-mirror.rancher.cn/rke2/install.sh | INSTALL_RKE2_MIRROR<span style=color:#f92672>=</span>cn sh -
</span></span><span style=display:flex><span>systemctl enable rke2-server.service
</span></span><span style=display:flex><span>systemctl start rke2-server.service
</span></span></code></pre></div><h4 id=配置介绍>配置介绍
<a class=anchor href=#%e9%85%8d%e7%bd%ae%e4%bb%8b%e7%bb%8d>#</a></h4><h5 id=tls-san><code>tls-san</code>
<a class=anchor href=#tls-san>#</a></h5><p><code>tls-san</code> 在 server 的 TLS 证书中增加了多个地址作为 <code>Subject Alternative Name</code>, 这样就可以通过 <code>lb.k8s.lan</code> 和 各个 server 节点 ip 访问 apiserver 服务.</p><a href=/posts/rke2/>...</a></div></article><ul class="pagination pagination-default"><li class="page-item disabled"><a aria-disabled=true aria-label=First class=page-link role=button tabindex=-1><span aria-hidden=true>&#171;&#171;</span></a></li><li class="page-item disabled"><a aria-disabled=true aria-label=Previous class=page-link role=button tabindex=-1><span aria-hidden=true>&#171;</span></a></li><li class="page-item active"><a aria-current=page aria-label="Page 1" class=page-link role=button>1</a></li><li class=page-item><a href=/posts/k8s/page/2/ aria-label="Page 2" class=page-link role=button>2</a></li><li class=page-item><a href=/posts/k8s/page/2/ aria-label=Next class=page-link role=button><span aria-hidden=true>&#187;</span></a></li><li class=page-item><a href=/posts/k8s/page/2/ aria-label=Last class=page-link role=button><span aria-hidden=true>&#187;&#187;</span></a></li></ul><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/go-bai/go-bai.github.io/commit/390d99988c3f7e00d9db00857e1ae58d43a80b98 title='Last modified by go-bai | 2025-03-02' target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt>
<span>2025-03-02</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav><ul><li class=book-section-flat><strong>Categories</strong><ul></ul></li><li class=book-section-flat><strong>Tags</strong><ul></ul></li></ul></nav></div></aside></main></body></html>